(()=>{"use strict";var t={154:(t,e,s)=>{const n=s(555);class i extends Array{constructor(t,e,s){super(),this.conRand=new n.myRandom(Math.round(1e3*s)),this.indRand=new n.myRandom(Math.round(1e3*R.random_dec()));for(let s=0;s<t;s++){const t=[];for(let s=0;s<e;s++)t.push(0);this.push(t)}}Grow(t,e,s,n){const i=Math.max(.001,.82*TX/Math.max(1,this.length));this.NoiseGrowth(14,100*this.conRand.rnd(),.005*i,-1,1,!0,100*this.conRand.rnd(),.004*i,!1,!0),this.NoiseGrowth(14,100*this.conRand.rnd(),.01*i,-.5,1,!0,100*this.conRand.rnd(),.008*i,!1,!0),this.NoiseGrowth(9,100*this.conRand.rnd(),.02*i,0,1,!0,10*this.conRand.rnd(),.008*i,!1,!0),this.NoiseGrowth(14,100*this.conRand.rnd(),.01*i,-.5,1,!0,100*this.conRand.rnd(),.008*i,!1,!0),this.NoiseGrowth(9,100*this.conRand.rnd(),.02*i,0,1,!0,10*this.conRand.rnd(),.008*i,!1,!0),this.CapDif(3,.008),this.erodeScale=t,this.erodeTime=e,this.depositScale=s,this.depositTime=n,this.Erode(3e5,.05,50/i,.075,.025,!0,this.erodeScale*i,this.erodeTime,this.depositScale*i,this.depositTime),this.Normalize(.05,1.7,!1,1),this.CapDif(3,.008),this.Resize(TX,TY),this.Erode(3e5,.05,50/i,.075,.025,!0,this.erodeScale*i,this.erodeTime,this.depositScale*i,this.depositTime),this.Normalize(.05,1,!1,1)}CapDif(t,e){for(let s=0;s<t;s++)for(let t=0;t<this.length;t++)for(let s=0;s<this[t].length;s++){if(LAND&&LAND.v0){const e=this.CoordinatesToWorld(t,s);if(LAND.v0.EvalFromWorld(e[0],e[1],!0)[2]<.3)continue}const n=this.MidH(t,s,1.2,this[t][s],!1);this[t][s]-n>e&&(this[t][s]=n+e)}this.RoundAll()}Refine(){this.Resize(T_SC*TX,T_SC*TY),this.Erode(3e5,.05,10*T_SC,.075,.025,!0,this.erodeScale/T_SC,this.erodeTime,this.depositScale/T_SC,this.depositTime),this.CapDif(3,.004)}NoiseGrowth(t,e,s,i,h,o,r,a,l,c){const u=this.RandomTransformation();for(let d=0;d<this.length;d++)for(let f=0;f<this[d].length;f++){const M=n.Rotate(d*u[1],f*u[2],u[0]);let m=(l?-1:1)*n.noise(M[0],M[1],e,s);c&&(m=Math.abs(m));const p=(Math.min(h,Math.max(i,m))-i)/Math.max(.1,h-i)*(o?this.Modulator(d,f,r,a):1);this[d][f]=Math.round(DEC*(this[d][f]+Math.round(DEC*t*p/45)/DEC))/DEC}}Modulator(t,e,s,i){return.5+Math.min(.5,Math.max(-.5,n.noise(t,e,s,i)-.25))}Curvature(t,e,s,n){const i=this.Eval(t,e,!0)[2],h=10*(.5+this.indRand.rnd())*(i-this.MidH(t,e,2*s*this.indRand.rnd(),i,!1));return h>0?Math.min(n,h):Math.max(-n,h)}Normal(t,e,s){const i=[t-s,e,this.EvalFromWorld(t-s,e,!0)[2]*U],h=[t+s,e,this.EvalFromWorld(t+s,e,!0)[2]*U],o=[t,e-s,this.EvalFromWorld(t,e-s,!0)[2]*U],r=[t,e+s,this.EvalFromWorld(t,e+s,!0)[2]*U];return n.normalize(n.CrossProduct(n.fromTo(i,h),n.fromTo(o,r)))}MidH(t,e,s,n,i){const h=[];i?(h.push(this.Eval(t,e-s,!0)[2]),h.push(this.Eval(t,e+s,!0)[2]),h.push(this.Eval(t-s,e,!0)[2]),h.push(this.Eval(t+s,e,!0)[2])):(h.push(this.Eval(t-s,e-s,!0)[2]),h.push(this.Eval(t-s,e+s,!0)[2]),h.push(this.Eval(t+s,e+s,!0)[2]),h.push(this.Eval(t+s,e-s,!0)[2]));let o=0,r=0;for(let t of h)o++,r+=t;return o>0?r/o:n}EvalFromWorld(t,e,s){const n=this.CoordinatesFromWorld(t,e);return this.Eval(n[0],n[1],s)}AddSphere(t,e,s,i,h,o,r,a,l){if(s<.001)return;const c=1/(s*s);for(let u=t-s;u<t+s+.01;u+=i)for(let d=e-s;d<e+s+.01;d+=i){const s=1-(Math.pow(t-u,2)+Math.pow(e-d,2))*c;s<0||this.SetValueFromWorld(u,d,h+(o-h)*s*(1+r*n.noise(u,d,442,a)),l)}}SetValueFromWorld(t,e,s,n){const i=this.CoordinatesFromWorld(t,e);this.SetValue(i[0],i[1],s,n)}CoordinatesFromWorld(t,e){if(0==this.length)return[t,e];return[this.length*(t+.5*S)/TX,this[0].length*(e+.5*S)/TY]}CoordinatesToWorld(t,e){if(0==this.length)return[t,e];if(0==this[0].length)return[t,e];const s=TX*t/this.length,n=TY*e/this[0].length;return[s-.5*S,n-.5*S]}Eval(t,e,s){const n=Math.max(0,Math.min(this.length-2,t)),i=Math.max(0,Math.min(this[0].length-2,e)),h=Math.max(0,Math.min(this.length-2,Math.floor(n))),o=Math.max(0,Math.min(this[0].length-2,Math.floor(i))),r=n-h,a=i-o,l=this[h][o],c=this[h+1][o],u=this[h][o+1],d=this[h+1][o+1],f=l*(1-r)*(1-a)+c*r*(1-a)+u*(1-r)*a+d*r*a;if(s)return[0,0,Math.round(DEC*f)/DEC];const M=(c-l)*(1-a)+(d-u)*a,m=(u-l)*(1-r)+(d-c)*r;return[Math.round(-DEC*M)/DEC,Math.round(-DEC*m)/DEC,Math.round(DEC*f)/DEC]}SetValue(t,e,s,n){const i=Math.max(0,Math.min(this.length-2,t)),h=Math.max(0,Math.min(this[0].length-2,e)),o=Math.max(0,Math.min(this.length-2,Math.floor(i))),r=Math.max(0,Math.min(this[0].length-2,Math.floor(h))),a=i-o,l=h-r;n==ADD?(this[o][r]+=Math.round(DEC*(s*(1-a)*(1-l)))/DEC,this[o+1][r]+=Math.round(DEC*(s*a*(1-l)))/DEC,this[o][r+1]+=Math.round(DEC*(s*(1-a)*l))/DEC,this[o+1][r+1]+=Math.round(DEC*(s*a*l))/DEC):n==MAX?(this[o][r]=Math.max(this[o][r],Math.round(DEC*(this[o][r]+(s-this[o][r])*(1-a)*(1-l)))/DEC),this[o+1][r]=Math.max(this[o+1][r],Math.round(DEC*(this[o+1][r]+(s-this[o+1][r])*a*(1-l)))/DEC),this[o][r+1]=Math.max(this[o][r+1],Math.round(DEC*(this[o][r+1]+(s-this[o][r+1])*(1-a)*l))/DEC),this[o+1][r+1]=Math.max(this[o+1][r+1],Math.round(DEC*(this[o+1][r+1]+(s-this[o+1][r+1])*a*l))/DEC)):n==MIN?(this[o][r]=Math.min(this[o][r],Math.round(DEC*(this[o][r]+(s-this[o][r])*(1-a)*(1-l)))/DEC),this[o+1][r]=Math.min(this[o+1][r],Math.round(DEC*(this[o+1][r]+(s-this[o+1][r])*a*(1-l)))/DEC),this[o][r+1]=Math.min(this[o][r+1],Math.round(DEC*(this[o][r+1]+(s-this[o][r+1])*(1-a)*l))/DEC),this[o+1][r+1]=Math.min(this[o+1][r+1],Math.round(DEC*(this[o+1][r+1]+(s-this[o+1][r+1])*a*l))/DEC)):(this[o][r]=Math.round(DEC*(this[o][r]+(s-this[o][r])*(1-a)*(1-l)))/DEC,this[o+1][r]=Math.round(DEC*(this[o+1][r]+(s-this[o+1][r])*a*(1-l)))/DEC,this[o][r+1]=Math.round(DEC*(this[o][r+1]+(s-this[o][r+1])*(1-a)*l))/DEC,this[o+1][r+1]=Math.round(DEC*(this[o+1][r+1]+(s-this[o+1][r+1])*a*l))/DEC)}Resize(t,e){if(t<1&&(t=1),e<1&&(e=1),this.length<2)return;if(this[0].length<2)return;const s=new i(0,0,this.conRand.rnd()),n=this.length/t,h=this[0].length/e;for(let i=0;i<t;i++){const t=[];for(let s=0;s<e;s++)t.push(this.Eval(i*n,s*h,!0)[2]);s.push(t)}this.splice(0,this.length);for(let t=0;t<s.length;t++)this.push(s[t])}Smooth(t,e,s){const n=new i(this.length,this[0].length,0);for(let i=0;i<t;i++){for(let t=0;t<this.length;t++)for(let e=0;e<this[t].length;e++)n[t][e]=this.MidH(t,e,1,this[t][e],s);for(let t=0;t<this.length;t++)for(let s=0;s<this[t].length;s++)this[t][s]+=e*(n[t][s]-this[t][s])}}MinMaxFromWorld(t,e,s,n){let i=9999,h=-9999;for(let o=t-s;o<t+s+.1;o+=n)for(let t=e-s;t<e+s+.1;t+=n){const e=this.EvalFromWorld(o,t,!0)[2];i>e&&(i=e),h<e&&(h=e)}return[i,h]}Normalize(t,e,s,n){let i=99999,h=-99999;for(let t=0;t<this.length;t++)for(let e=0;e<this[t].length;e++)i>this[t][e]&&(i=this[t][e]),h<this[t][e]&&(h=this[t][e]);if(Math.abs(h-i)>1||s&&h-i>.01)for(let s=0;s<this.length;s++)for(let o=0;o<this[s].length;o++)this[s][o]=Math.round(DEC*(t+(e-t)*Math.pow(Math.max(0,(this[s][o]-i)/Math.max(.1,h-i)),n)))/DEC;else for(let s=0;s<this.length;s++)for(let n=0;n<this[s].length;n++)this[s][n]=Math.round(DEC*(t+(e-t)*(this[s][n]-i)))/DEC}Erode(t,e,s,n,i,h,o,r,a,l){if(this.length-1<1)return;if(this[0].length-1<1)return;const c=this.length-1,u=this[0].length-1;for(let d=0;d<t;d++){let t=Math.round(DEC*this.indRand.rnd()*c)/DEC,d=Math.round(DEC*this.indRand.rnd()*u)/DEC;if(LAND&&LAND.v0){const e=this.CoordinatesToWorld(t,d);if(LAND.v0.EvalFromWorld(e[0],e[1],!0)[2]<.1)continue}let f=1,M=0;const m=Math.max(1,.5*this.indRand.rnd()*s);let p=0,g=0;const D=1/m;for(let s=0;s<m;s++){let s=Math.floor(t),c=Math.floor(d);if(s<=0||c<=0||s>=this.length-1||c>=this[0].length-1)break;const u=t-s,m=d-c,T=this.Eval(t,d,!1);p=e*p+(1-e)*T[0],g=e*g+(1-e)*T[1];const E=Math.sqrt(p*p+g*g);if(E>1e-4?(p/=E,g/=E):(p=0,g=0),t+=p,d+=g,t<.5||d<.5||t>this.length-1.5||d>this[0].length-1.5||0==p&&0==g)break;const C=this.Eval(t,d,!0)[2]-T[2],x=Math.max(.01,-C*f*40);if(M>x||C>0){const e=C>0?Math.min(C,M):(M-x)*n*this.Modify(t,d,h,a,l);M-=e,this[s][c]=Math.round(DEC*(this[s][c]+e*(1-u)*(1-m)))/DEC,this[s+1][c]=Math.round(DEC*(this[s+1][c]+e*u*(1-m)))/DEC,this[s][c+1]=Math.round(DEC*(this[s][c+1]+e*(1-u)*m))/DEC,this[s+1][c+1]=Math.round(DEC*(this[s+1][c+1]+e*u*m))/DEC}else{const e=Math.min(-C,(x-M)*i*this.Modify(t,d,h,o,r)),n=e*(1-u)*(1-m);this[s][c]=Math.round(DEC*(this[s][c]-n))/DEC;const a=e*u*(1-m);this[s+1][c]=Math.round(DEC*(this[s+1][c]-a))/DEC;const l=e*(1-u)*m;this[s][c+1]=Math.round(DEC*(this[s][c+1]-l))/DEC;const f=e*u*m;this[s+1][c+1]=Math.round(DEC*(this[s+1][c+1]-f))/DEC,M+=n+a+l+f}f-=D}}this.RoundAll()}RoundAll(){for(let t=0;t<this.length;t++)for(let e=0;e<this[t].length;e++)this[t][e]=Math.round(DEC*this[t][e])/DEC}RandomTransformation(){return[Math.round(DEC*this.conRand.rnd()*Math.PI)/DEC,Math.round(DEC*(.5+this.conRand.rnd()))/DEC,Math.round(DEC*(.5+this.conRand.rnd()))/DEC]}Modify(t,e,s,i,h){if(!s)return 1;const o=Math.max(0,Math.min(1,this.Eval(t,e,!0)[2]));return Math.round(DEC*(.55+.45*Math.max(-1,Math.min(1,o+1.2*n.noise(t,e,h,i)))))/DEC}}t.exports={Array2D:i}},824:t=>{t.exports={Random:class{constructor(){this.useA=!1;let t=function(t){let e=parseInt(t.substring(0,8),16),s=parseInt(t.substring(8,16),16),n=parseInt(t.substring(16,24),16),i=parseInt(t.substring(24,32),16);return function(){e|=0,s|=0,n|=0,i|=0;let t=(e+s|0)+i|0;return i=i+1|0,e=s^s>>>9,s=n+(n<<3)|0,n=n<<21|n>>>11,n=n+t|0,(t>>>0)/4294967296}};this.prngA=new t(tokenData.hash.substring(2,34)),this.prngB=new t(tokenData.hash.substring(34,66));for(let t=0;t<1e6;t+=2)this.prngA(),this.prngB()}random_dec(){return this.useA=!this.useA,this.useA?this.prngA():this.prngB()}}}},937:t=>{function e(t){let e=this,s=(n=4022871197,function(t){t=String(t);for(let e=0;e<t.length;e++){let s=.02519603282416938*(n+=t.charCodeAt(e));s-=n=s>>>0,s*=n,s-=n=s>>>0,n+=4294967296*s}return 2.3283064365386963e-10*(n>>>0)});var n;e.next=function(){let t=2091639*e.s0+2.3283064365386963e-10*e.c;return e.s0=e.s1,e.s1=e.s2,e.s2=t-(e.c=0|t)},e.c=1,e.s0=s(" "),e.s1=s(" "),e.s2=s(" "),e.s0-=s(t),e.s0<0&&(e.s0+=1),e.s1-=s(t),e.s1<0&&(e.s1+=1),e.s2-=s(t),e.s2<0&&(e.s2+=1),s=null}function s(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}t.exports={impl:function(t,n){let i=new e(t),h=n&&n.state,o=i.next;return o.int32=function(){return 4294967296*i.next()|0},o.double=function(){return o()+11102230246251565e-32*(2097152*o()|0)},o.quick=o,h&&("object"==typeof h&&s(h,i),o.state=function(){return s(i,{})}),o}}},80:(t,e,s)=>{const n=s(555);t.exports={BBlock:class{constructor(t,e,s,i,h){this.x0=t,this.x1=t+i,this.y0=e,this.y1=e+i,this.z0=s,this.z1=s+h,this.indRand=new n.myRandom(Math.round(1e3*(1+n.noise(t,e,s,77.072)))),this.isEmpty=!1,this.hasTerrain=!0,this.visible=!0,this.buildings=[],this.subtractions=[],this.agents=[],this.spans=[]}IsVisible(){for(let t=0;t<1.01;t+=.2)for(let e=0;e<1.01;e+=.2)for(let s=0;s<1.01;s+=.2)if(!(t>.01&&e>.01&&s>.01&&t<.99&&e<.99&&s<.99)&&CAM.IsOnScreen([this.x0+t*(this.x1-this.x0),this.y0+e*(this.y1-this.y0),this.z0+s*(this.z1-this.z0)],6))return!0;return!1}ResolveSpans(){for(let t=0;t<this.spans.length;t++){const e=this.spans[t],s=e.Eval(e.length/2),n=LAND.detailedMap.EvalFromWorld(s[0],s[1],!0)[2];e.weight=n,n<.05&&(this.spans.splice(t,1),t--)}}Resolve(){this.visible=this.IsVisible(),this.isEmpty=!0,this.hasTerrain=!1;for(let t=0;t<S+.1;t+=.5)for(let e=0;e<S+.1;e+=.5){LAND.Evaluate(this.x0+t,this.y0+e)>this.z0-2.5001&&(this.isEmpty=!1,this.hasTerrain=!0)}}copyPt(t){const e=[],s=this.shouldFlipNormal(t);for(let s=0;s<t.length;s++)if(5!=s)e.push(t[s]);else{const n=[];for(let e=0;e<t[s].length;e++)n.push(t[s][e]);e.push(n)}if(e.length<5&&e.push([0,0,0,t[0],t[1]]),s)for(let t=0;t<Math.min(3,e[5].length);t++)e[5][t]*=-1;return e}shouldFlipNormal(t){return t[0]<=this.x0+.001||!(t[0]>=this.x1-.001)&&(t[1]<=this.y0+.001||!(t[1]>=this.y1-.001)&&(t[2]<=this.z0+.001||(t[2],this.z1,!1)))}Domains(t){const e=[];for(let s of this.subtractions){const n=s.complexHit(t,!0);for(let t of n)e.push(t)}return n.HitIntervalSum(e)}SimpleHit(t,e){let s=null,i=[];for(let e of this.buildings){const s=e.complexHit(t,!1);for(let t of s)i.push(t)}return 0==i.length?null:(i=n.HitIntervalIntersect(e,n.HitIntervalSum(i)),0==i.length?null:(s=i[0][0],[s[0],s[1],s[2],BLDTYPE,s[4],0,s[5]]))}IntersectTerrain(t,e,s,i){if(0==e.length)return null;for(let h of e){const e=h[0][4],o=h[1][4]-e;if(o<0)continue;const r=Math.max(1,Math.round(o/D));let a=e;for(let l=0;l<r+.1;l+=1){let c=Math.min(l/r,1);c>.001&&c<.999&&(c=Math.max(0,Math.min(c+(this.indRand.rnd()-.5)/r,1)));let u=e+c*o,d=t.Eval(u);const f=LAND.EvaluateWithThickness(d[0],d[1]);let M=f[0]-d[2];const m=Math.max(-MINTH/5,Math.min(MINTH/5,.2*(this.indRand.rnd()-.5)));if(M>=-.01&&(f[1]>=MINTH+m||M>MINTH+1+m||u<=i+.001&&M>MINTH+1+m&&c<=.001&&(h[0][5][2]>.001||h[0][5][2]>-.001&&M>MINTH+m)||u>i+.001&&c<=.001&&(h[0][5][2]>.001||h[0][5][2]>-.001&&M>MINTH+m))){if(c<=.001)return[h[0][0],h[0][1],h[0][2],SOLTYPE,u,0,h[0][5]];let e=a,i=u,o=a,r=Math.abs(M);for(let s=0;s<7;s++){u=e+(i-e)*(.1+.8*this.indRand.rnd()),d=t.Eval(u);let s=LAND.EvaluateWithThickness(d[0],d[1]);if(M=s[0]-d[2],M>=-.01&&(s[1]>=MINTH+m||M>MINTH+1+m))i=u;else{e=u;const t=Math.abs(M);r>t&&(o=u,r=t)}}u=o,d=t.Eval(u);let l=LAND.EvaluateWithThickness(d[0],d[1]);if(M=l[0]-d[2],M<.05&&(d[2]=l[0]),u>s)return null;let f=M<.05?TERTYPE:CUTTYPE,p=[0,0,0,0,0];return f!=TERTYPE&&(p=n.normalize([l[2],l[3],0]),p.push(d[2])),[d[0],d[1],d[2],f,u,0,f==TERTYPE?LAND.Normal(d[0],d[1]):p]}if(a=u,u>s)return null}}return null}Intersect(t,e,s,i){const h=this.copyPt(t),o=this.copyPt(e);n.SetD(h[4]);const r=[];let a=i;const l=[[h,o]];if(this.buildings.length>0){const t=this.SimpleHit(s,l);t&&(r.push(t),a=Math.min(a,t[4]))}if(this.hasTerrain){const t=n.HitIntervalDifference(l,this.Domains(s)),e=t.length>0?this.IntersectTerrain(s,t,a,h[4]):null;e&&r.push(e)}let c=null;for(let t of r)(!c||c[4]>t[4])&&(c=t);return c}}}},470:(t,e,s)=>{const n=s(555),i=s(159);var h=0,o=[];class r{constructor(t,e,s){this.id=-1,this.feasable=!1,this.x=t,this.y=e,this.r=s/2,this.r2=this.r*this.r,this.rot=2*R.random_dec()*Math.PI,this.vec=[0,0,0],l(this.x,this.y,this.r,1.5)&&(this.feasable=!0,this.isChurch=!1,this.widthMult=1,this.setBBox(),this.boxes=[])}Update(){this.feasable=!0;const t=LAND.feasability.EvalFromWorld(this.x,this.y,!1);t[2]<.25&&(this.vec=n.addVec(this.vec,n.normalize([t[0],t[1],0]),-.1));const e=this.getRoads();for(let t of e){if(t.weight<.1)continue;const e=t.ClosestPoint([this.x,this.y,0]),s=e[0];let i=e[1];const h=n.normalize(n.fromTo([this.x,this.y,0],s));i>9*this.r2||(i=Math.sqrt(Math.max(0,i)),i<2*this.r&&(this.feasable=!1,this.vec=n.addVec(this.vec,h,i-2*this.r)),this.rot+=Math.min(1,3*t.weight*(3*this.r-i)/(3*this.r))*n.AngleDifference(Math.atan2(t.D[1],t.D[0]),this.rot))}const s=this.getNeighbours();for(let t of s){if(t.id<=this.id)continue;let e=n.fromTo([this.x,this.y,0],[t.x,t.y,0]);const s=Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=Math.max(.01,this.r+t.r);if(e=n.normalize(e),!(s>30)){if(s<i&&(this.vec=n.addVec(this.vec,e,-.5*(i-s)),t.vec=n.addVec(t.vec,e,.5*(i-s)),s<i-1&&t.feasable&&(this.feasable=!1)),s<2.5*i&&s>2*i){const h=Math.min(.3,.03*(s-2*i));this.vec=n.addVec(this.vec,e,h),t.vec=n.addVec(t.vec,e,-h)}s<3*i&&(this.rot+=.01*n.AngleDifference(t.rot,this.rot)*(1-s/(3*i)),t.rot+=.01*n.AngleDifference(this.rot,t.rot)*(1-s/(3*i)))}}}UpdatePos(){const t=this.x+this.vec[0],e=this.y+this.vec[1];l(t,e,this.r,this.isChurch?.01:.25)||(this.feasable=!1),this.x=t,this.y=e}setBBox(){const t=[this.x,this.y,0];this.bBox=new i.DomainCuboid(t,-30,30,-30,30,0,1,0,0),this.smBox=new i.DomainCuboid(t,-5*this.r,5*this.r,-5*this.r,5*this.r,0,1,0,0)}addToAgents(){if(this.vec=[0,0,0],this.setBBox(),this.bBox){this.boxes=this.bBox.getBoxes();for(let t of this.boxes)n.Contains(t.agents,this)||t.agents.push(this)}}getNeighbours(){const t=[];if(!this.boxes)return t;for(let e of this.boxes)if(e.agents)for(let s of e.agents)n.Contains(t,s)||t.push(s);return t}getRoads(){const t=[];if(!this.smBox)return t;this.smboxes=this.smBox.getBoxes();for(let e of this.smboxes)if(e.spans)for(let s of e.spans)n.Contains(t,s)||t.push(s);return t}addToBoxes(){if(!this.feasable)return;const t=[this.x,this.y,LAND.Evaluate(this.x,this.y)],e=n.RotateZ(1,0,0,this.rot),s=n.RotateZ(0,1,0,this.rot);if(this.isChurch&&LAND.d0.EvalFromWorld(this.x,this.y,!0)[2]>4){const o=1+.1*R.random_dec(),r=h;h=(h+1)%4;const a=1+.1*R.random_dec();i.House(t,4.2*o,2.5*o,3.2*o,this.rot,!0).addToBoxes();if(i.House(n.addVec(n.addVec(t,e,1.8*o*(r<3?1:0)),s,.95*o*(r<2?1:0)),.8*o,.8*o,o*a*4,this.rot,r>1).addToBoxes(),0==r){i.House(n.addVec(n.addVec(t,e,1.8*o),s,.95*-o),.8*o,.8*o,o*a*4,this.rot,!1).addToBoxes()}}else{const e=.7+.2*R.random_dec();i.House(t,2.5*e*this.widthMult,1.8*e,1.8*e,this.rot,!0).addToBoxes()}}}function a(t,e,s){if(LAND.v0.EvalFromWorld(t,e,!0)[2]<.3)return!1;if(LAND.h0.MinMaxFromWorld(t,e,s,s)[0]<5)return!1;if(LAND.feasability.MinMaxFromWorld(t,e,s,2*s)[0]<.2)return!1;if(LAND.connectionMap.MinMaxFromWorld(t,e,s,2*s)[0]>.22)return!1;if(LAND.Evaluate(t,e)>.75*U)return!1;const h=function(t,e,s){const h=new i.DomainCuboid([t,e,0],-s,s,-s,s,0,1,0,0).getBoxes(),o=[];for(let t of h)if(t.agents)for(let e of t.agents)n.Contains(o,e)||o.push(e);return o}(t,e,s);for(let n of h)if(n.feasable&&Math.pow(n.x-t,2)+Math.pow(n.y-e,2)<Math.pow(s+n.r,2))return!1;return!0}function l(t,e,s,n){if(s<1e-4)return!1;if(LAND.v0.EvalFromWorld(t,e,!0)[2]<.3)return!1;if(LAND.feasability.MinMaxFromWorld(t,e,s,s)[0]<.1)return!1;const i=LAND.connectionMap.MinMaxFromWorld(t,e,s,s);return!(i[n>=1?0:1]<.2*n||i[1]>.95)}function c(){for(let t of BLOCKS)for(let e of t)for(let t of e)t.agents=[]}t.exports={GenerateBuildings:function(){h=Math.floor(3.99*R.random_dec()),o=[];for(let t=0;t<TX;t+=14)for(let e=0;e<TY;e+=14){const s=R.random_dec()<.09;for(let n=0;n<4;n++){const n=10*R.random_dec()+t,i=10*R.random_dec()+e,h=s&&LAND.d0.EvalFromWorld(n,i,!0)[2]>4,a=1+Math.floor(1.7*Math.pow(R.random_dec(),2))/2,l=new r(n,i,h?7:3.5*a);if(l.feasable){l.id=o.length,l.isChurch=h,l.widthMult=a,o.push(l);break}}}for(let t=0;t<50;t++){c();for(let t of o)t.addToAgents();for(let t of o)t.Update();for(let t of o)t.UpdatePos()}},GenerateTrees:function(){for(let t=0;t<TX;t+=1.5)for(let e=0;e<TY;e+=1.5){const s=1.5*R.random_dec()+t,i=1.5*R.random_dec()+e,h=.7+.6*R.random_dec(),o=.5+.8*R.random_dec(),r=1.3+1.3*R.random_dec();n.noise(s,i,9,.012)+.25*(R.random_dec()-.5)<-.25||(R.random_dec()<.4||a(s,i,2)&&(LAND.treeColor.AddSphere(s,i,h,.1,-.2,-.35,.1,.1,MIN),LAND.trees.AddSphere(s,i,h,.1,o,r,.2,.04,MAX)))}for(let t of o)t.addToBoxes();for(let t=0;t<LAND.t0.length;t++)for(let e=0;e<LAND.t0[t].length;e++)LAND.t0[t][e]+=LAND.trees[t][e]/U,LAND.t0[t][e]-=.6*LAND.detailedMap[t][e]/U},GenerateFields:function(){const t=new n.myRandom(Math.round(1e3*R.random_dec()));for(let e=0;e<TX;e+=.45)for(let s=0;s<TY;s+=.45){const i=LAND.fieldMap.EvalFromWorld(e,s,!0)[2],h=Math.round(i);if(Math.abs(i-h)>.33)continue;if(h<=0)continue;if(!LAND.evaluateField(e,s))continue;const o=n.noise(0,0,h,.27)+.25,r=Math.PI*n.noise(0,0,h+11,.17),a=Math.max(.1,1.5+.25*n.noise(0,0,h+20,.38)),l=.7+.2*n.noise(0,0,h+30,.3),c=n.RotateZ(1,0,0,r),u=n.DotProduct([e,s,0],c);if(Math.abs(u)%a<l*a){const n=.25*(t.rnd()-.5),i=.25*(t.rnd()-.5);LAND.treeColor.SetValueFromWorld(e+n,s+i,o*(.85+.6*t.rnd()),o>0?MAX:MIN),LAND.trees.SetValueFromWorld(e+n,s+i,.66+.5*t.rnd(),MAX)}}}}},6:(t,e,s)=>{const n=s(555),i=s(159);var h=[];function o(t,e,s){for(let n=0;n<h.length;n++)if(h[n].isSame(t,e,s))return h[n];const n=new i.Cylinder(t,e,s);return h.push(n),n}function r(t,e,s,h,o,r,a){for(let l=0;l<t.length;l++){const c=n.IntervalSum(s[l]),u=n.IntervalSum(e[l]),d=n.IntervalSum(h[l]);for(let e of c){const s=new i.DomainCuboid(o,-500,500,e[0]-a/2,e[1]-a/2,-Z,U,0,r);t[l].removeAllFromBoxes(s)}for(let e of u){const s=new i.DomainCuboid(o,-500,500,e[0]-a/2,e[1]-a/2,-Z,U,0,r);t[l].removeBottomFromBoxes(s)}for(let e of d){const s=new i.DomainCuboid(o,-500,500,e[0]-a/2,e[1]-a/2,-Z,U,0,r);t[l].removeTopFromBoxes(s)}}}class a{constructor(t,e,s,h,o,r,a,l,c){this.width=e;const u=n.RotateZ(1,0,0,l),d=n.RotateZ(0,c,0,l),f=t+this.width/2-h/2,M=n.addVec([TX/2,TY/2,0],d,f),m=M[0],p=M[1],g=999,D=this.width-s,T=a?this.width*Math.sqrt(3):this.width;this.bboxBot=new i.CenterCuboid([m,p,o+r/2],g,D,r+T,0,l),this.bboxTop=new i.CenterCuboid([m,p,o+3*r/2],g,D,r+T,0,l),this.bbox=new i.CenterCuboid([m,p,o+r],g,D,2*r+T,0,l),this.cylBottom=this.createVault([m,p,o],u,d,s,(this.width-s)/2,a),this.cylMid=this.createVault([m,p,o+r],u,d,s,(this.width-s)/2,a),this.cylTop=this.createVault([m,p,o+2*r],u,d,s,(this.width-s)/2,a),this.boxBottom=new i.CenterCuboid([m,p,o+r/2],g,D,r,0,l),this.boxTop=new i.CenterCuboid([m,p,o+3*r/2],g,D,r,0,l),this.boxSum=new i.CenterCuboid([m,p,o+r],g,D,2*r,0,l)}createVault(t,e,s,h,r,a){if(a){const a=o(n.addVec(t,s,r+h/2),e,2*r+h/2),l=o(n.addVec(t,s,-r-h/2),e,2*r+h/2);return new i.IntersectShape(a,l)}return o(t,e,r)}removeBottomFromBoxes(t){if(t){const e=new i.IntersectShape(t,new i.SumShape([this.cylBottom,this.cylMid,this.boxBottom]));e.bounds=new i.IntersectShape(this.bboxBot,t).bBox(),e.removeFromBoxes()}else this.cylBottom.removeFromBoxes(),this.cylMid.removeFromBoxes(),this.boxBottom.removeFromBoxes()}removeTopFromBoxes(t){if(t){const e=new i.IntersectShape(t,new i.SumShape([this.cylMid,this.cylTop,this.boxTop]));e.bounds=new i.IntersectShape(this.bboxTop,t).bBox(),e.removeFromBoxes()}else this.cylMid.removeFromBoxes(),this.cylTop.removeFromBoxes(),this.boxTop.removeFromBoxes()}removeAllFromBoxes(t){if(t){const e=new i.IntersectShape(t,new i.SumShape([this.cylBottom,this.cylTop,this.boxSum]));e.bounds=new i.IntersectShape(this.bbox,t).bBox(),e.removeFromBoxes()}else this.cylBottom.removeFromBoxes(),this.cylTop.removeFromBoxes(),this.boxSum.removeFromBoxes()}}t.exports={Grid3d:class{constructor(t,e,s,n){h=[],this.mar=2.5,this.startH=MODULE/2,s&&(this.startH=MODULE*Math.sqrt(3)/2),this.stepH=MODULE/2,this.heights=[MODULE/2,MODULE/2],t==SIXTY?this.sixtyDegrees(s):this.orthoGrid(e,s,n)}orthoGrid(t,e,s){this.widths=this.fillArray(TX,MODULE/4,e,0,!1,1),this.depths=this.fillArray(TY,MODULE/4,e,t,!1,-1),s==FRAGMENTED?this.occupancyOrtho(t,TX,TY):(this.occupancyNonOrtho(this.widths,0,1),OMITSECOND||this.occupancyNonOrtho(this.depths,1,1))}sixtyDegrees(t){const e=R.random_dec()<.5;this.occupancyNonOrtho(this.fillArray(TX,MODULE/4,t,0,e,1),0,e?1:0),this.occupancyNonOrtho(this.fillArray(TX,MODULE/4,t,Math.PI/3,e,1),1,e?1:0),this.occupancyNonOrtho(this.fillArray(TX,MODULE/4,t,-Math.PI/3,e,1),2,e?1:0)}occupancyNonOrtho(t,e,s){for(let i=0;i<t.length;i++){const h=[];for(let t=0;t<this.heights.length;t++){const o=n.noise(i,10*e,10*t*s,.085);h.push(o>.05*(R.random_dec()-.5)*s-.14&&o<.14+.05*(R.random_dec()-.5)*s)}h[0]&&h[1]?t[i].removeAllFromBoxes():h[0]?t[i].removeBottomFromBoxes():h[1]&&t[i].removeTopFromBoxes()}}occupancyOrtho(t,e,s){const i=[TX/2,TY/2,0],h=n.MultiArray(this.widths.length),o=n.MultiArray(this.depths.length),a=n.MultiArray(this.widths.length),l=n.MultiArray(this.depths.length),c=n.MultiArray(this.widths.length),u=n.MultiArray(this.depths.length);let d=0;for(let t=0;t<this.widths.length;t++){let e=this.widths[t].width,s=0;for(let i=0;i<this.depths.length;i++){let r=this.depths[i].width;const f=[],M=[];h[t].push([s,s+r]),o[i].push([d,d+e]);for(let e=0;e<this.heights.length;e++){const s=n.noise(t,i,10*e,.055),h=n.noise(t,i,10*e+5,.055);f.push(s>-.17&&s<.17),M.push(h<.17&&h>-.17)}a[t].push(f[0]),c[t].push(f[1]),l[i].push(M[0]),u[i].push(M[1]),s+=r}d+=e}for(let t=0;t<this.widths.length;t++)for(let e=0;e<this.depths.length;e++)0!=e&&e!=this.depths.length-1||(a[t][e]=!1,c[t][e]=!1),0!=t&&t!=this.widths.length-1||(l[e][t]=!1,u[e][t]=!1);let f=0,M=!0;for(;f<999&&M;){M=!1,f++;for(let t=1;t<this.widths.length-1;t++)for(let e=1;e<this.depths.length-1;e++)!c[t][e]||c[t][e-1]||c[t][e+1]||(c[t][e]=!1,M=!0),!u[e][t]||u[e][t-1]||u[e][t+1]||(u[e][t]=!1,M=!0),!a[t][e]||a[t][e-1]||a[t][e+1]||(a[t][e]=!1,M=!0),!l[e][t]||l[e][t-1]||l[e][t+1]||(l[e][t]=!1,M=!0),l[e][t]&&u[e][t]&&(!l[e][t+1]&&!u[e][t-1]||!l[e][t-1]&&!u[e][t+1])&&(l[e][t]=!1,u[e][t]=!1,M=!0),a[t][e]&&c[t][e]&&(!a[t][e+1]&&!c[t][e-1]||!a[t][e-1]&&!c[t][e+1])&&(a[t][e]=!1,c[t][e]=!1,M=!0),a[t][e]&&a[t][e-1]!=a[t][e+1]&&l[e][t]&&l[e][t-1]!=l[e][t+1]&&(this.widths[t].width>=this.depths[e].width?a[t][e]=!1:l[e][t]=!1,M=!0),c[t][e]&&c[t][e-1]!=c[t][e+1]&&u[e][t]&&u[e][t-1]!=u[e][t+1]&&(this.widths[t].width>=this.depths[e].width?c[t][e]=!1:u[e][t]=!1,M=!0)}const m=n.MultiArray(this.widths.length),p=n.MultiArray(this.depths.length),g=n.MultiArray(this.widths.length),D=n.MultiArray(this.depths.length),T=n.MultiArray(this.widths.length),E=n.MultiArray(this.depths.length);for(let t=1;t<this.widths.length-1;t++)for(let e=1;e<this.depths.length-1;e++){const s=[h[t][e][0],h[t][e][1]],n=[h[t][e][0],h[t][e][1]],i=(s[1]+s[0])/2,r=[o[e][t][0],o[e][t][1]],d=[o[e][t][0],o[e][t][1]],f=(r[1]+r[0])/2;a[t][e+1]?s[1]+=.1:s[1]-=this.mar/2,a[t][e-1]?s[0]-=.1:s[0]+=this.mar/2,c[t][e+1]?n[1]+=.1:n[1]-=this.mar/2,c[t][e-1]?n[0]-=.1:n[0]+=this.mar/2,a[t][e]&&l[e][t]&&this.widths[t].width<=this.depths[e].width&&(a[t][e+1]||(s[1]=i),a[t][e-1]||(s[0]=i)),c[t][e]&&u[e][t]&&this.widths[t].width<=this.depths[e].width&&(c[t][e+1]||(n[1]=i),c[t][e-1]||(n[0]=i));const M=Math.abs(s[0]-n[0])<.001&&Math.abs(s[1]-n[1])<.001;l[e][t+1]?r[1]+=.1:r[1]-=this.mar/2,l[e][t-1]?r[0]-=.1:r[0]+=this.mar/2,u[e][t+1]?d[1]+=.1:d[1]-=this.mar/2,u[e][t-1]?d[0]-=.1:d[0]+=this.mar/2,l[e][t]&&a[t][e]&&this.widths[t].width>=this.depths[e].width&&(l[e][t+1]||(r[1]=f),l[e][t-1]||(r[0]=f)),u[e][t]&&c[t][e]&&this.widths[t].width>=this.depths[e].width&&(u[e][t+1]||(d[1]=f),u[e][t-1]||(d[0]=f));const C=Math.abs(d[0]-r[0])<.001&&Math.abs(d[1]-r[1])<.001;a[t][e]&&c[t][e]&&M?g[t].push(s):(a[t][e]&&m[t].push(s),c[t][e]&&T[t].push(n)),l[e][t]&&u[e][t]&&C?D[e].push(r):(l[e][t]&&p[e].push(r),u[e][t]&&E[e].push(d))}r(this.widths,m,g,T,i,t+Math.PI,s),r(this.depths,p,D,E,i,0,e)}fillArray(t,e,s,n,i,h){const o=[];let r=0,l=0,c=!1;for(;r<t-1&&l<9999;){let u=0;c?c=!1:(u=Math.round(.2+1.4*R.random_dec()),0==u&&(c=!0)),i&&(u=1);const d=Math.min(Math.pow(2,u)*e,t-r);o.push(new a(r,d,this.mar,t,this.startH,this.stepH,s,n,h)),r+=d,l++}return o}}}},374:(t,e,s)=>{const n=s(154),i=s(555),h=s(38);t.exports={Mountain:class{constructor(t,e,s,i){this.conR=R.random_dec(),this.t0=new n.Array2D(.5*TX,.5*TY,this.conR),this.t0.Grow(t,e,s,i),this.detailedMap=new n.Array2D(T_SC*TX,T_SC*TY,this.conR),this.trees=new n.Array2D(T_SC*TX,T_SC*TY,this.conR),this.treeColor=new n.Array2D(T_SC*TX,T_SC*TY,this.conR)}CalculateVisibility(){this.v0=new n.Array2D(TX/2,TY/2,this.conR);for(let t=0;t<this.v0.length;t++)for(let e=0;e<this.v0[t].length;e++){const s=this.v0.CoordinatesToWorld(t,e);this.v0[t][e]=CAM.IsOnScreen([s[0],s[1],this.Evaluate(s[0],s[1])],6)?1:0}}CalculateHabitat(){const t=.75;this.feasability.Resize(.5*TX,.5*TY),this.cities=new n.Array2D(this.feasability.length,this.feasability[0].length,this.conR);for(let e=0;e<this.feasability.length;e++)for(let s=0;s<this.feasability[e].length;s++){if(this.feasability[e][s]<0)continue;this.feasability[e][s]=-1;const n=this.feasability.CoordinatesToWorld(e+.1*(this.feasability.indRand.rnd()-.5),s+.1*(this.feasability.indRand.rnd()-.5)),h=i.Trace(new i.Ray([n[0],n[1],U+1],[0,0,-1]),1e3,!0);h&&(h[3]==TERTYPE&&(h[6][2]<t||(this.feasability[e][s]=(h[6][2]-t)/.25,h[6][2]>.95&&(this.cities[e][s]=1))))}this.cities.Smooth(2,1,!1),this.cities.Erode(5e4,.05,20,.025,.025,!1,1,1,1,1),this.feasability.RoundAll(),this.cities.RoundAll(),this.connectionMap=new n.Array2D(.75*TX,.75*TY,this.conR);const e=new h.WalkMap(this.conR);for(var s=0;s<16;s++)e.NextPath(12*(s+2),.7+.25*s/16);LAND.detailedMap.Normalize(0,1,!0,.25),this.connectionMap.Smooth(8,1,!0),this.connectionMap.Normalize(0,1,!0,.33),this.connectionMap.RoundAll(),this.detailedMap.RoundAll(),this.fieldMap=new n.Array2D(T_SC*TX,T_SC*TY,this.conR);let o=0;for(let t=0;t<this.fieldMap.length;t++)for(let e=0;e<this.fieldMap[t].length;e++){if(Math.abs(this.fieldMap[t][e])>.1)continue;if(!this.isFieldCorrect(t,e)){this.fieldMap[t][e]=-1;continue}o++,this.fieldMap[t][e]=o;const s=Math.round(800+500*this.fieldMap.indRand.rnd());let n=[[t,e]],i=0,h=1;for(;n.length>0&&i<1999&&h<s;){const t=[];i++;for(let e of n){const s=this.getFieldNeighbours(e,o);for(let e of s)t.push(e),h++}n=t}}}isFieldCorrect(t,e){const s=this.fieldMap.CoordinatesToWorld(t,e);return this.evaluateField(s[0],s[1])}evaluateField(t,e){if(this.v0.EvalFromWorld(t,e,!0)[2]<.3)return!1;if(this.h0.EvalFromWorld(t,e,!0)[2]<2)return!1;if(this.feasability.MinMaxFromWorld(t,e,1.5,3)[0]<.15)return!1;const s=this.connectionMap.EvalFromWorld(t,e,!0)[2];if(s<.1||s>.6)return!1;return!(LAND.detailedMap.EvalFromWorld(t,e,!0)[2]>.25)}getFieldNeighbours(t,e){const s=t[0],n=t[1],i=[];for(let t=-1;t<1.1;t++)for(let h=-1;h<1.1;h++){if(0==t&&0==h)continue;const o=s+t,r=n+h;o<0||r<0||o>=this.fieldMap.length||r>=this.fieldMap[0].length||(Math.abs(this.fieldMap[o][r])>.5||(this.isFieldCorrect(o,r)?(this.fieldMap[o][r]=e,i.push([o,r])):this.fieldMap[o][r]=-1))}return i}CalculateThickness(){this.t0.Refine(),this.d0=new n.Array2D(this.t0.length,this.t0[0].length,this.conR),this.feasability=new n.Array2D(this.t0.length,this.t0[0].length,this.conR);for(let t=0;t<this.d0.length;t++)for(let e=0;e<this.d0[t].length;e++){const s=this.d0.CoordinatesToWorld(t,e);if(this.v0.EvalFromWorld(s[0],s[1],!0)[2]<.3){this.d0[t][e]=U;continue}const n=this.t0.EvalFromWorld(s[0],s[1],!0)[2]*U,h=i.GetBoxes([[[s[0]+.001,s[0]+.001]],[[s[1]+.001,s[1]+.001]],[[-Z,n]]]),o=new i.Ray([s[0],s[1],n],[0,0,-1]),r=[];for(let t=0;t<h.length;t++){const e=h[h.length-1-t];if(!e.visible)continue;if(!e.hasTerrain)continue;if(e.z0<n-2*S)break;const s=e.Domains(o);for(let t of s)r.push(t);if(s.length>0)break}const a=i.HitIntervalSum(r);let l=!1;for(let s of a){if(s[0][4]<0&&s[1][4]>0){l=!0,this.d0[t][e]=-Math.round(DEC*s[1][4])/DEC;break}if(s[0][4]>0){l=!0,this.d0[t][e]=Math.min(U,Math.round(DEC*s[0][4])/DEC);break}}l||(this.d0[t][e]=U),this.d0[t][e]<MINTH+2&&(this.feasability[t][e]=-1)}this.h0=new n.Array2D(TX/2,TY/2,this.conR);for(let t=0;t<this.h0.length;t++)for(let e=0;e<this.h0[t].length;e++){const s=this.h0.CoordinatesToWorld(t,e);if(this.v0.EvalFromWorld(s[0],s[1],!0)[2]<.3||this.d0.EvalFromWorld(s[0],s[1],!0)[2]<MINTH){this.h0[t][e]=0;continue}const n=this.t0.EvalFromWorld(s[0],s[1],!0)[2]*U,h=i.GetBoxes([[[s[0]+.001,s[0]+.001]],[[s[1]+.001,s[1]+.001]],[[n,U]]]),o=new i.Ray([s[0],s[1],n],[0,0,1]),r=[];for(let t=0;t<h.length;t++){const e=h[t];if(!e.visible)continue;if(!e.hasTerrain)continue;const s=e.Domains(o);for(let t of s)r.push(t);if(s.length>0)break}const a=i.HitIntervalSum(r);let l=!1;for(let s of a){if(s[0][4]<0&&s[1][4]>0){l=!0,this.h0[t][e]=0;break}if(s[0][4]>0){l=!0,this.h0[t][e]=Math.min(U,Math.round(DEC*s[0][4])/DEC);break}}l||(this.h0[t][e]=U)}this.alreadyVisited=new n.Array2D(this.t0.length,this.t0[0].length,this.conR);const t=new n.Array2D(this.t0.length,this.t0[0].length,this.conR);for(let e=0;e<this.t0.length;e++)for(let s=0;s<this.t0[e].length;s++){const n=this.d0.CoordinatesToWorld(e,s);if(this.v0.EvalFromWorld(n[0],n[1],!0)[2]<.3)continue;const i=this.d0[e][s];if(i<MINTH_TRIM||this.alreadyVisited[e][s]>.5)continue;const h=[[e,s,i]];let o=[[e,s,i]],r=0;i>U-1&&r++,this.alreadyVisited[e][s]=1;let a=0,l=0,c=0;for(;o.length>0&&a<9999;){const t=[];a++;for(let e of o){const s=this.getNeighbours(e);r+=s[1],l+=s[2],c+=s[3];for(let e of s[0])t.push(e),h.push(e)}o=t}if(c>0&&(l/=c),!(r>0||l>.5))for(let e of h){if(t[e[0]][e[1]]>.5)continue;const s=e[2];!s||s<0||(this.t0[e[0]][e[1]]-=s/U,this.d0[e[0]][e[1]]=0,t[e[0]][e[1]]=1)}}for(let e=1;e<this.t0.length-1;e++)for(let s=1;s<this.t0[e].length-1;s++){const n=this.d0.CoordinatesToWorld(e,s);if(this.v0.EvalFromWorld(n[0],n[1],!0)[2]<.3)continue;const i=this.d0[e][s];if(i>0&&i<MINTH_TRIM&&t[e][s]<.5&&this.alreadyVisited[e][s]<.5){let n=-1;for(let i=-1;i<1.1;i++)for(let h=-1;h<1.1;h++){if(0==i&&0==h)continue;const o=e+i,r=s+h,a=this.d0[o][r];this.alreadyVisited[o][r]>.5&&t[o][r]<.5&&a>0&&(n<0||n>a)&&(n=a)}if(n>=i)continue;n<0&&(n=0),this.t0[e][s]-=(i-n)/U,this.d0[e][s]=n}}let e=!0,s=0;for(;e&&s<100;){const t=new n.Array2D(this.d0.length,this.d0[0].length,this.conR);s++,e=!1;for(let n=0;n<this.d0.length;n++)for(let i=0;i<this.d0[n].length;i++){if(t[n][i]=this.d0[n][i],n<1||i<1||n>=this.d0.length-1||i>=this.d0[n].length-1)continue;if(this.d0[n][i]>=0)continue;e=!0;const h=[];if(this.d0[n+1][i]>=0&&h.push(this.d0[n+1][i]),this.d0[n-1][i]>=0&&h.push(this.d0[n-1][i]),this.d0[n][i+1]>=0&&h.push(this.d0[n][i+1]),this.d0[n][i-1]>=0&&h.push(this.d0[n][i-1]),0==h.length)continue;let o=U;s>=3&&(o=MINTH+.1);for(let t of h)o=Math.min(t,o);t[n][i]=o}this.d0=t}this.d0.Smooth(3,.5,!0),this.t0.RoundAll()}getNeighbours(t){const e=t[0],s=t[1],n=this.d0.CoordinatesToWorld(e,s),i=this.v0.EvalFromWorld(n[0],n[1],!0)[2];if(this.d0[e][s]<MINTH_TRIM||i<.3)return[[],0,0,0];let h=0,o=0;const r=[];let a=0;for(let t=-1;t<1.1;t++)for(let n=-1;n<1.1;n++){if(0==t&&0==n)continue;const i=e+t,l=s+n;if(i<0||l<0||i>=this.t0.length||l>=this.t0[0].length)continue;if(this.alreadyVisited[i][l]>.5)continue;const c=this.d0[i][l];this.alreadyVisited[i][l]=1,r.push([i,l,c<0?this.d0[e][s]:c]),c<MINTH_TRIM&&(o++,c>-MINTH-3&&c<=0&&this.d0[e][s]>MINTH+3&&h++),c>U-1&&a++}return[r,a,h,o]}CalcCurve(t,e){const s=this.t0.CoordinatesFromWorld(t,e),n=s[0],i=s[1];let h=2.5*(.8+.2*this.t0.Eval(n,i,!0)[2]);return.55*h*this.t0.Curvature(n,i,15*T_SC,1)+.55*h*this.t0.Curvature(n,i,3*T_SC,1)+3*h*this.t0.Curvature(n,i,.5*T_SC,1)}Evaluate(t,e){return this.t0.EvalFromWorld(t,e,!0)[2]*U}EvaluateWithThickness(t,e){let s=this.t0.EvalFromWorld(t,e,!0)[2],n=this.d0.EvalFromWorld(t,e,!1);return[s*U,n[2],n[0],n[1]]}Normal(t,e){const s=this.t0.Normal(t,e,1);return s.push(Math.abs(i.DotProduct([t-TX/2,e-TY/2,0],STRIPEV))),s}}}},413:t=>{function e(t){let e=new Uint32Array(1);return e[0]=1664525*t[0]+1013904223,e}const s=(Math.sqrt(4)-1)/3,n=(1/Math.sqrt(4)-1)/3;function i(t,e,n,i){return{dx:-e-t*s,dy:-n-t*s,dz:-i-t*s,xsb:e,ysb:n,zsb:i}}const h=[[0,0,0,0,1,1,0,0,1,0,1,0,1,0,0,1],[2,1,1,0,2,1,0,1,2,0,1,1,3,1,1,1],[1,1,0,0,1,0,1,0,1,0,0,1,2,1,1,0,2,1,0,1,2,0,1,1]],o=[-11,4,4,-4,11,4,-4,4,11,11,4,4,4,11,4,4,4,11,-11,-4,4,-4,-11,4,-4,-4,11,11,-4,4,4,-11,4,4,-4,11,-11,4,-4,-4,11,-4,-4,4,-11,11,4,-4,4,11,-4,4,4,-11,-11,-4,-4,-4,-11,-4,-4,-4,-11,11,-4,-4,4,-11,-4,4,-4,-11],r=[0,2,1,1,2,2,5,1,6,0,7,0,32,2,34,2,129,1,133,1,160,5,161,5,518,0,519,0,546,4,550,4,645,3,647,3,672,5,673,5,674,4,677,3,678,4,679,3,680,13,681,13,682,12,685,14,686,12,687,14,712,20,714,18,809,21,813,23,840,20,841,21,1198,19,1199,22,1226,18,1230,19,1325,23,1327,22,1352,15,1353,17,1354,15,1357,17,1358,16,1359,16,1360,11,1361,10,1362,11,1365,10,1366,9,1367,9,1392,11,1394,11,1489,10,1493,10,1520,8,1521,8,1878,9,1879,9,1906,7,1910,7,2005,6,2007,6,2032,8,2033,8,2034,7,2037,6,2038,7,2039,6],a=[0,0,1,-1,0,0,1,0,-1,0,0,-1,1,0,0,0,1,-1,0,0,-1,0,1,0,0,-1,1,0,2,1,1,0,1,1,1,-1,0,2,1,0,1,1,1,-1,1,0,2,0,1,1,1,-1,1,1,1,3,2,1,0,3,1,2,0,1,3,2,0,1,3,1,0,2,1,3,0,2,1,3,0,1,2,1,1,1,0,0,2,2,0,0,1,1,0,1,0,2,0,2,0,1,1,0,0,1,2,0,0,2,2,0,0,0,0,1,1,-1,1,2,0,0,0,0,1,-1,1,1,2,0,0,0,0,1,1,1,-1,2,3,1,1,1,2,0,0,2,2,3,1,1,1,2,2,0,0,2,3,1,1,1,2,0,2,0,2,1,1,-1,1,2,0,0,2,2,1,1,-1,1,2,2,0,0,2,1,-1,1,1,2,0,0,2,2,1,-1,1,1,2,0,2,0,2,1,1,1,-1,2,2,0,0,2,1,1,1,-1,2,0,2,0];t.exports={makeNoise3D:function(t){const l=[];for(let t=0;t<a.length;t+=9){const e=h[a[t]];let s=null,n=null;for(let h=0;h<e.length;h+=4)n=i(e[h],e[h+1],e[h+2],e[h+3]),null===s?l[t/9]=n:s.next=n,s=n;n.next=i(a[t+1],a[t+2],a[t+3],a[t+4]),n.next.next=i(a[t+5],a[t+6],a[t+7],a[t+8])}const c=[];for(let t=0;t<r.length;t+=2)c[r[t]]=l[r[t+1]];const u=new Uint8Array(256),d=new Uint8Array(256),f=new Uint8Array(256);for(let t=0;t<256;t++)f[t]=t;let M=new Uint32Array(1);M[0]=t,M=e(e(e(M)));for(let t=255;t>=0;t--){M=e(M);const s=new Uint32Array(1);s[0]=(M[0]+31)%(t+1),s[0]<0&&(s[0]+=t+1),u[t]=f[s[0]],d[t]=u[t]%24*3,f[s[0]]=f[t]}return function(t,e,i){const h=(t+e+i)*n,r=t+h,a=e+h,l=i+h,f=Math.floor(r),M=Math.floor(a),m=Math.floor(l),p=(f+M+m)*s,g=t-(f+p),D=e-(M+p),T=i-(m+p),E=r-f,C=a-M,x=l-m,R=E+C+x;let S=0;for(let t=c[C-x+1|E-C+1<<1|E-x+1<<2|R<<3|R+x<<5|R+C<<7|R+E<<9];void 0!==t;t=t.next){const e=g+t.dx,s=D+t.dy,n=T+t.dz,i=2-e*e-s*s-n*n;if(i>0){const h=f+t.xsb,r=M+t.ysb,a=m+t.zsb,l=u[255&h],c=u[l+r&255],p=d[c+a&255];S+=i*i*i*i*(o[p]*e+o[p+1]*s+o[p+2]*n)}}return.009708737864077669*S}}}},290:(t,e,s)=>{const n=s(555),i=s(159);function h(t,e,s){return t+Math.floor((s+.9)*R.random_dec())*e}t.exports={Domes:function(){const t=R.random_dec()>.5,e=.5+.4*R.random_dec(),s=(.7+.4*R.random_dec())*U,h=t?2*s:s*Math.sqrt(3),o=s+3,r=[],a=[],l=[];let c=-1,u=-1,d=[0,0,0];const f=[];f.push([0,0]),t?f.push([h*e/2,s*e]):f.push([2*h*e/3,0]),f.push([0,s*e]);const M=f[Math.max(0,Math.min(f.length-1,Math.floor(Math.pow(R.random_dec(),2)*(f.length-.01))))];let m=0;for(let i=0;i<TX;i+=h*e){let h=0;t||m%2!=1||(h=s*e),m++;for(let t=h;t<TY;t+=2*s*e){const h=Math.min((.5+.25*R.random_dec())*s,1.25*s*e),o=[(TX-S)/2-i,(TY-S)/2-t,0],r=n.Distance([0,0,0],o);(c<0||r<u)&&(c=l.length,u=r,d=o),l.push([i,t,h])}}for(let t=0;t<l.length;t++){const e=l[t];let n=e[0]+d[0]+M[0],h=e[1]+d[1]+M[1];const u=new i.Sphere([n,h,o],s),f=new i.Sphere([n,h,e[2]-3],e[2]);R.random_dec()<.25&&t!=c||(r.push(u),a.push(f))}const p=new i.SumShape(r),g=new i.SumShape(a);new i.DifferenceShape(p,g).removeFromBoxes()},Signs:function(){const t=R.random_dec()<=.5;let e=0,s=0,o=999,r=-999;for(let t=-4*S;t<4.1*S;t+=S)for(let n=-4*S;n<4.1*S;n+=S){const i=LAND.Evaluate(t+(TX-S)/2,n+(TY-S)/2);o=Math.min(i,o),r=Math.max(i,r),e+=i,s++}s>.1&&(e/=s);const a=S/3;o=Math.max(e+.25*(o+2*a-e),2*a);const l=Math.max(1,Math.round(r-o-3*a)),c=5+Math.floor(3.99*R.random_dec()),u=[];for(let t=0;t<c;t++){const t=.5*(2+Math.floor(2.99*Math.pow(R.random_dec(),1.5)))*a;u.push(t)}let d=0;for(let t=0;t<c-1;t++)d+=u[t]+u[t+1];const f=[0,1,0],M=[1,0,0],m=n.addVec([(TX-S)/2,(TY-S)/2,o],f,-TY/2);let p=0,g=0,D=h(u[0],.5*a,5),T=1,E=9999,C=[0,0,0];const x=[],b=[];for(;0<TY&&p<999;){const t=n.addVec(m,f,g),e=D+d+u[0]+u[u.length-1];let s=D;const i=n.fromTo([t[0],t[1],0],CENTERPT),o=n.Distance([0,0,0],i);o<E&&(E=o,C=i);for(let i=0;i<u.length;i++){let h=u[i];x.push([n.addVec(t,M,e*T),2*e+.001]),b.push([t,s,h-1]),s+=h,i<u.length-1&&(s+=u[i+1])}u.reverse(),g+=D+d,D=h(u[0],.5*S,4),g+=D,p++,T*=-1}for(let e=0;e<x.length;e++){const s=new i.CenterCuboid(n.addVec(x[e][0],C,E<45?1:0),x[e][1],x[e][1],2*U,0,0);let h=i.TorusVault(n.addVec(b[e][0],C,E<45?1:0),b[e][1],b[e][2],l);for(let e=0;e<h.length;e++){let n=h[e];t&&(n=new i.IntersectShape(s,n)),n.removeFromBoxes()}}}}},479:(t,e,s)=>{const n=s(555);var i=new n.myRandom(0),h=1,o=0;function r(t,e){const s=.15+.35*(.6*n.noise(t[0],t[1],t[2],.8)+.35+.4*i.rnd()+.4*(1+n.noise(t[0],t[1],t[2],6.9))),h=t[3]==BLDTYPE?.5:1,o=Math.abs(t[6][3]+999*STRIPEMULT)%(STRIPEMULT*h),r=Math.min(1,Math.max(0,.05+.47*s))/(2*h);if(t[3]!=CUTTYPE&&o<STRIPEMULT*(.5+r)*h&&o>STRIPEMULT*(.5-r)*h){const s=n.DotProduct(t[6],STRIPEV);return t[3]!=TERTYPE||Math.abs(s)<.6&&!(Math.abs(t[6][2])>.63&&e>.63)}return!1}function a(t,e,s){const n=[],i=Math.min(3,t.length,e.length);for(let h=0;h<i;h++)n.push(t[h]-s*(1-e[h]));return n}function l(t,e,s){const n=[],i=Math.min(3,t.length,e.length);for(let h=0;h<i;h++)n.push(t[h]+s*e[h]);return n}function c(t,e,s){const n=[],i=Math.min(3,t.length,e.length);for(let h=0;h<i;h++)n.push(t[h]+s*(e[h]-t[h]));return n}function u(t,e,o,r){let a=n.addVec(t,t[6],.02+.02*i.rnd()*h);t[3]==TERTYPE&&(a=n.addVec(t,[0,0,1],.02));let l=1.5*(.5*(.5*n.DotProduct(t[6],n.RotateXZ(LV[0],LV[1],LV[2],h*(i.rnd()-.5),h*(i.rnd()-.5)))+1)-.5);if(s.g.DDOM=[.2*MODULE,1.5*MODULE,.5,2],o||r){const t=n.Trace(new n.Ray(a,n.RotateXZ(LV[0],LV[1],LV[2],.125*(i.rnd()-.5),.125*(i.rnd()-.5))),TX/3,!0);l+=null!=t?Math.min(1,t[4]/(TX/3)):1}else l+=1-.75*e;return l=1.125*(l+.125),t[3]==TERTYPE&&(l+=.4*t[5]),l}t.exports={renderLight:function(t,e){h=(W+H)/8e3,0==t&&(mainCtx.fillStyle="#212124",mainCtx.fillRect(-10,-10,W+20,H+20)),i=new n.myRandom(o),o++;const d=Math.floor(t/RENMOD2),f=1/Math.max(1,d+1),M=CAM.planeY,m=CAM.planeX;let p=CAM.GetVector();const g=Math.max(10,Math.round(1e6/W));let D=Math.ceil(H/g),T=0,E=H;const C=Math.round(W/2),x=-C,R=Math.round(H/2);for(let h=0;h<D;h++){const o=Math.min(g,E);try{D>1&&console.log("rendering pass "+(t+1)+", fragment "+(h+1)+"/"+D)}catch{}T+=o,E-=o;const S=mainCtx.getImageData(0,E,W,o),b=S.data,I=-R+T-o,y=-R+T;for(let h=x;h<C;h++){const o=h+C,g=RENMOD*(o%RENMOD);for(let D=I;D<y;D++){const T=D+R;if(g+T%RENMOD!=t%RENMOD2)continue;let C=n.addVec(CAM.planeO,m,SC*(h+(i.rnd()-.5)));C=n.addVec(C,M,SC*(D+(i.rnd()-.5)));const x=n.getColorIndices(o,T,W,H,E),S=[b[x[0]],b[x[1]],b[x[2]]];let I=[0,0,0];s.g.DDOM=[800,500,1,2];let y=n.Trace(new n.Ray(C,p),e,!1);if(null==y){if(y=n.RayXY(-Z,new n.Ray(C,p)),!y)continue;y=[y[0],y[1],y[2],0,y[4],0,[0,0,1,y[0],y[1]]]}let A=0,v=0,O=0,w=0;y[3]==TERTYPE&&(v=LAND.detailedMap.EvalFromWorld(y[0],y[1],!0)[2],A=LAND.treeColor.EvalFromWorld(y[0],y[1],!0)[2],w=LAND.CalcCurve(y[0],y[1]),O=6*Math.max(0,Math.min(.6,v)-.3+.5*(i.rnd()-.5))+1.5*(A+1.5*(i.rnd()-.5)),y[5]=w+O);const P=Math.max(0,Math.min(1,(n.CalculateDepth(y[2],y[4])-MINDEPTH)/Math.max(.1,MAXDEPTH-MINDEPTH)));let N=r(y,w),B=y[3]==TERTYPE&&(Math.abs(y[6][2])<.7+.2*(i.rnd()-.5)&&w>.05&&Math.abs(A)<.01||w>.9);let L=u(y,P,N,P<DEPTH_2+DEPTH_2_*i.rnd()&&P>DEPTH_1-DEPTH_1_*i.rnd()),_=[1,1,1];y[3]==TERTYPE?_=B?STNCLR:TERCLR:y[3]==CUTTYPE?_=CUTCLR:y[3]==SOLTYPE?_=SOLCLR:y[3]==BLDTYPE&&(_=BLDCLR);let X=SHDCLR;N&&(L<.7||L>1.2)&&(X=BLKCLR),I=a(_,X,1-L),I=c(I,l(X,LGHCLR,.5*Math.sqrt(P)),.3*P),b[x[0]]=(d*S[0]+255*I[0])*f,b[x[1]]=(d*S[1]+255*I[1])*f,b[x[2]]=(d*S[2]+255*I[2])*f}}mainCtx.putImageData(S,0,E)}}}},38:(t,e,s)=>{const n=s(555);class i{constructor(t,e,s){this.altmap=[],this.visited=!1,this.nearest=null,this.mincost=-1,this.x=t,this.y=e,this.h=s}Reset(){this.visited=!1,this.nearest=null,this.mincost=-1}}t.exports={WalkMap:class{constructor(t){this.minima=[],this.nodes=[],this.rand=new n.myRandom(Math.round(1e3*t));for(let t=0;t<250;t++){const e=[];for(let s=0;s<250;s++){const n=Math.round(DEC*(this.rand.rnd()+t)*TX/250)/DEC,h=Math.round(DEC*(this.rand.rnd()+s)*TY/250)/DEC,o=LAND.Evaluate(n,h),r=new i(n,h,o);e.push(r),LAND.cities.EvalFromWorld(n,h,!0)[2]>.2&&this.minima.push(r)}this.nodes.push(e)}for(let t=0;t<this.nodes.length;t++)for(let e=0;e<this.nodes[t].length;e++){const s=t-1,n=t+1,i=e+1;this.calcConnection(t,e,t,i),this.calcConnection(t,e,n,e),this.calcConnection(t,e,n,i),this.calcConnection(t,e,s,i)}}calcConnection(t,e,s,i){if(t<0||t>=this.nodes.length||e<0||e>=this.nodes[0].length||s<0||s>=this.nodes.length||i<0||i>=this.nodes[0].length)return;const h=this.nodes[t][e],o=this.nodes[s][i],r=LAND.feasability.EvalFromWorld(h.x,h.y,!0)[2],a=LAND.feasability.EvalFromWorld(o.x,o.y,!0)[2],l=LAND.feasability.EvalFromWorld((h.x+o.x)/2,(h.y+o.y)/2,!0)[2];if(r>.1&&a>.1&&l>.1){const t=n.Distance([h.x,h.y,h.h],[o.x,o.y,o.h])*(1.2+n.noise((h.x+o.x)/2,(h.y+o.y)/2,3560,.001)),e=Math.round(DEC*t*Math.pow(1.2-l,2))/DEC;h.altmap.push([o,e]),o.altmap.push([h,e])}}DijkstraSearch(t){for(let t=0;t<this.nodes.length;t++)for(let e=0;e<this.nodes[t].length;e++)this.nodes[t][e].Reset();t.mincost=0;const e=[];e.push(t);let s=0;do{if(s++,0==e.length)break;const t=e[0];if(e.splice(0,1),!t.visited){for(let s=0;s<t.altmap.length;s++){const n=t.altmap[s],i=n[0],h=n[1];i.visited||(i.mincost<-.1||t.mincost+h<i.mincost)&&(i.mincost=t.mincost+h,i.nearest=t,e.push(i))}t.visited=!0}}while(e.length>0&&s<99999);return s}Reduce(t,e){return Math.round(DEC*Math.max(Math.min(1e-4,t),(1-e)*t))/DEC}NextPath(t,e){let s=0,i=0,h=null;for(;s<10&&i<50;){try{h=this.ClosestCity(this.rand.rnd()),s=this.DijkstraSearch(h)}catch{}i++}for(let s=0;s<t;s++){const t=this.ClosestCity(this.rand.rnd());if(h==t)continue;const s=this.BuildPath(t);if(!(s.length<3))for(let t=0;t<s.length-1;t++){const i=s[t],h=s[t+1];new n.Span([i.x,i.y,0],[h.x,h.y,0]).addToBoxes();for(let t=0;t<1.01;t+=.07){const e=i.x+t*(h.x-i.x),s=i.y+t*(h.y-i.y);LAND.connectionMap.SetValueFromWorld(e,s,.02,ADD),LAND.detailedMap.SetValueFromWorld(e,s,.02,ADD)}for(let t=0;t<i.altmap.length;t++)if(i.altmap[t][0]==h){i.altmap[t][1]=this.Reduce(i.altmap[t][1],e);break}for(let t=0;t<h.altmap.length;t++)if(h.altmap[t][0]==i){h.altmap[t][1]=this.Reduce(h.altmap[t][1],e);break}}}}ClosestCity(t){return this.minima[Math.min(this.minima.length-1,Math.max(0,Math.round(t*(this.minima.length-1))))]}BuildPath(t){const e=[];e.push(t);let s=t;for(let t=0;t<500&&s;t++){const t=s.nearest;if(!t)break;e.push(t),s=t}return e}}}},159:(t,e,s)=>{const n=s(555);class i{constructor(){this.rO=null,this.lastHit=[],this.bounds=null}checkRays(t){let e=t.Same(this.rO);return this.rO=t,e}complexHit(t,e){return this.checkRays(t)||(this.lastHit=this.hit(t,e)),this.lastHit}hit(t,e){return[]}bBox(){return this.bounds?this.bounds:[[],[],[]]}getBoxes(){let t=this.bBox();const e=[],s=n.GetBoxes(t);for(let t of s)n.Contains(e,t)||e.push(t);return e}isApplicable(t){return this.isBlockClose(t)}isBlockFullyIn(t){return!1}isBlockClose(t){return!0}addToBoxes(){const t=this.getBoxes();for(let e of t)e.visible&&!n.Contains(e.buildings,this)&&this.isApplicable(e)&&(e.buildings.push(this),e.isEmpty=!1)}removeFromBoxes(){const t=this.getBoxes();for(let e of t)e.visible&&!n.Contains(e.subtractions,this)&&this.isApplicable(e)&&e.subtractions.push(this)}}class h extends i{constructor(t,e){super(),this.compound1=t,this.compound2=e}hit(t,e){const s=this.compound1.complexHit(t,e);if(0==s.length)return s;const i=this.compound2.complexHit(t,!e);return n.HitIntervalDifference(s,i)}bBox(){return this.bounds?this.bounds:this.compound1.bBox()}isBlockClose(t){return this.compound1.isBlockClose(t)&&!this.compound2.isBlockFullyIn(t)}isBlockFullyIn(t){return this.compound1.isBlockFullyIn(t)&&!this.compound2.isBlockClose(t)}isApplicable(t){return this.compound1.isBlockClose(t)&&!this.compound2.isBlockFullyIn(t)}}class o extends i{constructor(t,e){super(),this.compound1=t,this.compound2=e}hit(t,e){const s=this.compound1.complexHit(t,e);if(0==s.length)return s;const i=this.compound2.complexHit(t,e);return n.HitIntervalIntersect(s,i)}bBox(){if(this.bounds)return this.bounds;const t=this.compound1.bBox(),e=this.compound2.bBox();return n.BoxIntersect(t,e)}isBlockClose(t){return this.compound1.isBlockClose(t)&&this.compound2.isBlockClose(t)}isBlockFullyIn(t){return this.compound1.isBlockFullyIn(t)&&this.compound2.isBlockFullyIn(t)}isApplicable(t){return!!this.compound1.isBlockClose(t)&&this.compound2.isBlockClose(t)}}class r extends i{constructor(t,e,s,n,i,h,o,r,a){super(),this.X=[e,s],this.Y=[n,i],this.Z=[h,o],this.flipUV=!1,this.rx=r,this.rz=a,this.pt=[t[0],t[1],t[2]],this.XV=this.RotateVec(1,0,0),this.YV=this.RotateVec(0,1,0),this.ZV=this.RotateVec(0,0,1)}RotateVec(t,e,s){return n.RotateXZ(t,e,s,this.rx,this.rz)}RotateBack(t,e,s){return n.RotateZX(t,e,s,-this.rx,-this.rz)}getAllPoints(){const t=[];for(let e=0;e<1.1;e++)for(let s=0;s<1.1;s++)for(let i=0;i<1.1;i++){const h=n.addVec(n.addVec(n.addVec(this.pt,this.XV,this.X[0]+e*(this.X[1]-this.X[0])),this.YV,this.Y[0]+s*(this.Y[1]-this.Y[0])),this.ZV,this.Z[0]+i*(this.Z[1]-this.Z[0]));t.push(h)}return t}bBox(){if(this.bounds)return this.bounds;let t=9999,e=9999,s=9999,n=-9999,i=-9999,h=-9999;const o=this.getAllPoints();for(let r of o)t>r[0]&&(t=r[0]),e>r[1]&&(e=r[1]),s>r[2]&&(s=r[2]),n<r[0]&&(n=r[0]),i<r[1]&&(i=r[1]),h<r[2]&&(h=r[2]);return[[[t,n]],[[e,i]],[[s,h]]]}flip(t,e){if(!e)return t;const s=[];for(let e=0;e<t.length;e++)s.push(t[e]);if(s.length>=6)for(let t=0;t<Math.min(3,s[5].length);t++)s[5][t]*=-1;return s}alignedHit(t,e){const s=[],i=n.RayYZ(this.X[0],t),h=n.RayYZ(this.X[1],t),o=n.RayXZ(this.Y[0],t),r=n.RayXZ(this.Y[1],t),a=n.RayXY(this.Z[0],t),l=n.RayXY(this.Z[1],t);if(i[3]&&i[1]>=this.Y[0]&&i[1]<=this.Y[1]&&i[2]>=this.Z[0]&&i[2]<=this.Z[1]&&s.push(this.flip(i,!e)),h[3]&&h[1]>=this.Y[0]&&h[1]<=this.Y[1]&&h[2]>=this.Z[0]&&h[2]<=this.Z[1]&&s.push(this.flip(h,!!e)),o[3]&&o[0]>this.X[0]&&o[0]<this.X[1]&&o[2]>=this.Z[0]&&o[2]<=this.Z[1]&&s.push(this.flip(o,!e)),r[3]&&r[0]>this.X[0]&&r[0]<this.X[1]&&r[2]>=this.Z[0]&&r[2]<=this.Z[1]&&s.push(this.flip(r,!!e)),a[3]&&a[0]>this.X[0]&&a[0]<this.X[1]&&a[1]>this.Y[0]&&a[1]<this.Y[1]&&s.push(this.flip(a,!e)),l[3]&&l[0]>this.X[0]&&l[0]<this.X[1]&&l[1]>this.Y[0]&&l[1]<this.Y[1]&&s.push(this.flip(l,!!e)),this.flipUV)for(let t of s){if(t.length<6||t[5].length<5)continue;const e=t[5][3];t[5][3]=t[5][4],t[5][4]=e}return 2!=s.length?0!=s.length?(s.sort((function(t,e){return t[4]-e[4]})),[[s[0],s[s.length-1]]]):[]:s[0][4]<s[1][4]?[s]:[[s[1],s[0]]]}hit(t,e){let s=n.fromTo(this.pt,t.O),i=this.RotateBack(s[0],s[1],s[2]);const h=this.alignedHit(new n.Ray(i,this.RotateBack(t.D[0],t.D[1],t.D[2])),e);if(!h||0==h.length)return[];for(let e=0;e<h.length;e++)for(let s=0;s<h[e].length;s++){if(h[e][s].length<6||h[e][s][5].length<3)continue;let n=t.Eval(h[e][s][4]);h[e][s][0]=n[0],h[e][s][1]=n[1],h[e][s][2]=n[2];let i=this.RotateVec(h[e][s][5][0],h[e][s][5][1],h[e][s][5][2]);h[e][s][5][0]=i[0],h[e][s][5][1]=i[1],h[e][s][5][2]=i[2]}return h}isBlockClose(t){const e=this.blockRemapDom(t);return n.IntervalsOverlap(e[0],this.X)&&n.IntervalsOverlap(e[1],this.Y)&&n.IntervalsOverlap(e[2],this.Z)}isBlockFullyIn(t){const e=this.blockRemapDom(t);return n.IntervalInInterval(e[0],this.X)&&n.IntervalInInterval(e[1],this.Y)&&n.IntervalInInterval(e[2],this.Z)}blockRemapDom(t){let e=n.fromTo(this.pt,[(t.x0+t.x1)/2,(t.y0+t.y1)/2,(t.z0+t.z1)/2]),s=this.RotateBack(e[0],e[1],e[2]);return[[s[0]-.5*DIAG,s[0]+.5*DIAG],[s[1]-.5*DIAG,s[1]+.5*DIAG],[s[2]-.5*DIAG,s[2]+.5*DIAG]]}}class a extends r{constructor(t,e,s,n,i,h){super(t,-e/2,e/2,-s/2,s/2,-n/2,n/2,i,h)}}class l extends i{constructor(t,e,s){super(),this.r=s,this.r2=s*s,this.pt=t,this.axis=e,this.uvMult=1}bBox(){if(this.bounds)return this.bounds;const t=this.pt[0]-999*this.axis[0],e=this.pt[0]+999*this.axis[0],s=this.pt[1]-999*this.axis[1],n=this.pt[1]+999*this.axis[1],i=this.pt[2]-999*this.axis[2],h=this.pt[2]+999*this.axis[2];return[[[Math.min(t,e)-this.r,Math.max(t,e)+this.r]],[[Math.min(s,n)-this.r,Math.max(s,n)+this.r]],[[Math.min(i,h)-this.r,Math.max(i,h)+this.r]]]}hit(t,e){const s=n.RayCylinder(t,this.pt,this.axis,this.r2);return!s||s.length<2||!s[0][3]||!s[1][3]?[]:(s[0].push(this.getNormal(s[0],e)),s[1].push(this.getNormal(s[1],e)),[s])}getNormal(t,e){const s=n.fromTo(this.pt,t),i=n.DotProduct(s,this.axis),h=n.addVec(this.pt,this.axis,i);let o=n.normalize(n.fromTo(h,t));return e&&(o=n.multVec(o,-1)),o.push(i*this.uvMult),o}isSame(t,e,s){return this.pt[0]==t[0]&&(this.pt[1]==t[1]&&(this.pt[2]==t[2]&&(this.r==s&&(this.axis[0]==e[0]&&(this.axis[1]==e[1]&&this.axis[2]==e[2])))))}isBlockFullyIn(t){return this.blockDistance(t)<this.r-.5*DIAG}isBlockClose(t){return this.blockDistance(t)<this.r+.5*DIAG}blockDistance(t){const e=[(t.x0+t.x1)/2,(t.y0+t.y1)/2,(t.z0+t.z1)/2],s=n.fromTo(this.pt,e),i=n.DotProduct(s,this.axis),h=n.addVec(this.pt,this.axis,i);return n.Distance(h,e)}}class c extends i{constructor(t,e,s){super(),this.pt=t,this.bigR=e,this.smallR=s,this.one_r=1/Math.max(.001,s),this.bigR2=e*e,this.smallR2=s*s,this.sphereR2=Math.pow(e+s,2),this.smallCircumf=4*STRIPEMULT*Math.round(2*Math.PI*this.smallR/(4*STRIPEMULT))/(2*Math.PI)}bBox(){return this.bounds?this.bounds:[[[this.pt[0]-this.bigR-this.smallR,this.pt[0]+this.bigR+this.smallR]],[[this.pt[1]-this.bigR-this.smallR,this.pt[1]+this.bigR+this.smallR]],[[this.pt[2]-this.smallR,this.pt[2]+this.smallR]]]}hit(t,e){const s=new n.Ray(n.addVec(t.O,this.pt,-1),t.D);let i=1,h=n.DotProduct(s.O,s.O),o=n.DotProduct(s.O,s.D);if(o*o-h+this.sphereR2<0)return[];let r=(h-this.bigR2-this.smallR2)/2,a=o,l=o*o+this.bigR2*s.D[2]*s.D[2]+r,c=o*r+this.bigR2*s.O[2]*s.D[2],u=r*r+this.bigR2*s.O[2]*s.O[2]-this.bigR2*this.smallR2;if(Math.abs(a*(a*a-l)+c)<.01&&0!=u){i=-1;const t=c;c=a,a=t,u=1/u,c*=u,l*=u,a*=u}let d=2*l-3*a*a,f=a*(a*a-l)+c,M=a*(a*(-3*a*a+4*l)-8*c)+4*u;d/=3,f*=2,M/=3;let m=d*d+M,p=3*M*d-d*d*d-f*f,g=p*p-m*m*m,D=0;if(g<0){if(m<=0)return[];const t=Math.sqrt(m);D=2*t*Math.cos(Math.acos(Math.min(1,Math.max(-1,p/(t*m))))/3)}else{const t=Math.pow(Math.sqrt(g)+Math.abs(p),1/3);if(0==t)return[];D=Math.sign(p)*Math.abs(t+m/t)}D=d-D;let T=D-3*d,E=D*D-3*M;if(Math.abs(T)<1e-4){if(E<0)return[];E=Math.sqrt(E)}else{if(T<=0)return[];T=Math.sqrt(T/2),E=f/T}const C=[];if(g=T*T-D+E,g>0){g=Math.sqrt(g);let t=-T-g-a;if(i<0&&0==t)return[];t=i<0?2/t:t;let e=-T+g-a;if(i<0&&0==e)return[];e=i<0?2/e:e,C.push(t),C.push(e)}if(g=T*T-D-E,g>0){g=Math.sqrt(g);let t=T-g-a;if(i<0&&0==t)return[];t=i<0?2/t:t;let e=T+g-a;if(i<0&&0==e)return[];e=i<0?2/e:e,C.push(t),C.push(e)}C.sort((function(t,e){return t-e}));const x=[];for(let s of C){const n=t.Eval(s);n.push(!0),n.push(s),n.push(this.getNormal(n,e)),x.push(n)}return 2==x.length?[[x[0],x[1]]]:4==x.length?[[x[0],x[1]],[x[2],x[3]]]:[]}getNormal(t,e){const s=this.circleCP(t);let i=n.normalize(n.fromTo(s,t));e&&(i=n.multVec(i,-1));const h=Math.min(1,Math.max(-1,(t[2]-s[2])*this.one_r)),o=Math.acos(h);return i.push(o*this.smallCircumf),i}isBlockFullyIn(t){return this.blockDistance(t)<this.smallR-.5*DIAG}isBlockClose(t){return this.blockDistance(t)<this.smallR+.5*DIAG}circleCP(t){const e=n.fromTo(this.pt,t),s=n.normalize([e[0],e[1],0]);return 0==s[0]&&0==s[1]&&0==s[2]&&(s[0]=1),n.addVec(this.pt,s,this.bigR)}blockDistance(t){const e=[(t.x0+t.x1)/2,(t.y0+t.y1)/2,(t.z0+t.z1)/2],s=this.circleCP(e);return n.Distance(s,e)}}t.exports={IntersectShape:o,DifferenceShape:h,SumShape:class extends i{constructor(t){super(),this.compound=t}hit(t,e){let s=[];for(let n of this.compound){const i=n.complexHit(t,e);for(let t of i)s.push(t)}return s=n.HitIntervalSum(s),s}bBox(){if(this.bounds)return this.bounds;const t=[];for(let e of this.compound){const s=e.bBox();t.push(s)}return n.BoxSum(t)}isBlockClose(t){for(let e of this.compound)if(e.isBlockClose(t))return!0;return!1}isBlockFullyIn(t){for(let e of this.compound)if(e.isBlockFullyIn(t))return!0;return!1}isApplicable(t){for(let e of this.compound)if(e.isBlockClose(t))return!0;return!1}},CenterCuboid:a,DomainCuboid:r,Sphere:class extends i{constructor(t,e){super(),this.r=e,this.one_r=1/Math.max(.1,this.r),this.r2=e*e,this.pt=t}bBox(){return this.bounds?this.bounds:[[[this.pt[0]-this.r,this.pt[0]+this.r]],[[this.pt[1]-this.r,this.pt[1]+this.r]],[[this.pt[2]-this.r,this.pt[2]+this.r]]]}hit(t,e){const s=n.RaySphere(this.pt,this.r2,t);return!s||s.length<2||!s[0][3]||!s[1][3]?[]:(s[0].push(this.getNormal(s[0],e)),s[1].push(this.getNormal(s[1],e)),[s])}getNormal(t,e){const s=Math.min(1,Math.max(-1,(t[2]-this.pt[2])*this.one_r)),i=Math.acos(s);let h=n.normalize(n.fromTo(this.pt,t));return e&&(h=n.multVec(h,-1)),h.push(i*this.r),h}isBlockFullyIn(t){return this.blockDistance(t)<this.r-.5*DIAG}isBlockClose(t){return this.blockDistance(t)<this.r+.5*DIAG}blockDistance(t){return n.Distance(this.pt,[(t.x0+t.x1)/2,(t.y0+t.y1)/2,(t.z0+t.z1)/2])}},Cylinder:l,House:function(t,e,s,i,h,r){const l=n.RotateZ(1,0,0,h),c=n.RotateZ(0,1,0,h);for(let i=-.5-e/2;i<.051+e/2;i+=.25)for(let e=-.5-s/2;e<.51+s/2;e+=.25){const s=n.addVec(n.addVec(t,l,i),c,e);LAND.trees.SetValueFromWorld(s[0],s[1],0,REPLACE),LAND.treeColor.SetValueFromWorld(s[0],s[1],0,REPLACE)}const u=new a(t,e,s,2*i,0,h);if(u.flipUV=!0,r){const s=new a(t,e,i*Math.SQRT2,i*Math.SQRT2,Math.PI/4,h);return new o(u,s)}return u},TorusVault:function(t,e,s,i){const a=new c(t,e,s),u=n.addVec(t,[0,0,1],i),d=new c(u,e,s),f=new r(t,-e-s,e+s,-e-s,e+s,0,i,0,0),M=new l(u,[0,0,-1],e+s),m=new l(u,[0,0,-1],e-s);if(0!=i){const t=Math.round(i/STRIPEMULT)*STRIPEMULT/i;M.uvMult=t,m.uvMult=t}return[a,new o(f,new h(M,m)),d]}}},555:(t,e,s)=>{const n=s(937);var i;function h(t,e){for(let s of t)if(e==s)return!0;return!1}function o(t,e){const s=Math.min(3,t.length,e.length);let n=0;for(let i=0;i<s;i++)n+=Math.pow(e[i]-t[i],2);return n}function r(t,e){return Math.sqrt(o(t,e))}function a(t){const e=[];if(t.length<3)return e;if(BLOCKS.length<1)return e;if(BLOCKS[0].length<1)return e;if(BLOCKS[0][0].length<1)return e;for(let s of t[0])for(let n of t[1])for(let i of t[2]){const t=Math.min(BLOCKS.length-1,Math.max(0,Math.floor(s[0]/S))),o=Math.min(BLOCKS[0].length-1,Math.max(0,Math.floor(n[0]/S))),r=Math.min(BLOCKS[0][0].length-1,Math.max(0,Math.floor((i[0]+Z)/SZ))),a=Math.max(0,Math.min(BLOCKS.length-1,Math.floor(s[1]/S))),l=Math.max(0,Math.min(BLOCKS[0].length-1,Math.floor(n[1]/S))),c=Math.max(0,Math.min(BLOCKS[0][0].length-1,Math.floor((i[1]+Z)/SZ)));for(let s=t;s<a+.1;s++)for(let t=o;t<l+.1;t++)for(let n=r;n<c+.1;n++){const i=BLOCKS[s][t][n];i&&(h(e,i)||e.push(i))}}return e}function l(t){const e=function(t){if(!t||t.length<3)return null;const e=Math.floor(t[0]/S);if(e<0||e>=BLOCKS.length)return null;const s=Math.floor(t[1]/S);if(s<0||s>=BLOCKS[e].length)return null;const n=Math.floor((t[2]+Z)/SZ);return n<0||n>=BLOCKS[e][s].length?null:BLOCKS[e][s][n]}(t);return!e||e.isEmpty?null:e}function c(t,e,s,n,i,h,o){return!t||t.length<3?null:!(t[0]<e-.01)&&(!(t[1]<n-.01)&&(!(t[2]<h-.01)&&(!(t[0]>s+.01)&&(!(t[1]>i+.01)&&!(t[2]>o+.01)))))}function u(t,e){if(e.Z0)return[0,0,0,!1,-10,[0,0,0,0,0]];const s=(t-e.O[2])*e.iZ,n=e.O[0]+s*e.D[0],i=e.O[1]+s*e.D[1];return[n,i,e.O[2]+s*e.D[2],!0,s,[0,0,1,n,i]]}function d(t,e){if(e.Y0)return[0,0,0,!1,-10,[0,0,0,0,0]];const s=(t-e.O[1])*e.iY,n=e.O[0]+s*e.D[0],i=e.O[1]+s*e.D[1],h=e.O[2]+s*e.D[2];return[n,i,h,!0,s,[0,1,0,n,h]]}function f(t,e){if(e.X0)return[0,0,0,!1,-10,[0,0,0,0,0]];const s=(t-e.O[0])*e.iX,n=e.O[0]+s*e.D[0],i=e.O[1]+s*e.D[1],h=e.O[2]+s*e.D[2];return[n,i,h,!0,s,[1,0,0,i,h]]}function M(t,e){return!(t<e[0])&&!(t>e[1])}function m(t,e){for(let s of e)if(M(t,s))return!0;return!1}function p(t){const e=[];for(let s=0;s<t.length;s++)e.push([t[s][0],s,0]),e.push([t[s][1],s,1]);return e.sort((function(t,e){return t[0]-e[0]})),e}function g(t,e,s){const n=[];let i=[-999,0,0],h=[-999,0,0],o=!1;for(let r=0;r<t.length-1;r++)e[r]&&(h=t[r+1],o||(i=t[r]),o=!0),e[r]&&r!=t.length-2||(o&&n.push([s[i[1]][i[2]],s[h[1]][h[2]]]),o=!1);return n}function D(t,e,s,n){if(0==t.length)return[];if(0==e.length)return[];const i=[],h=[];for(let e=0;e<t.length;e++)i.push(t[e]),h.push(null!=s&&s.length==t.length?s[e]:t[e]);for(let t=0;t<e.length;t++)i.push(e[t]),h.push(null!=n&&n.length==e.length?n[t]:e[t]);const o=p(i),r=[];for(let s=0;s<o.length-1;s++){const n=.5*(o[s][0]+o[s+1][0]);r.push(m(n,t)&&m(n,e))}return g(o,r,h)}function T(t,e){if(0==t.length)return[];const s=p(t),n=[];for(let e=0;e<s.length-1;e++){const i=.5*(s[e][0]+s[e+1][0]);n.push(m(i,t))}return g(s,n,null!=e&&e.length==t.length?e:t)}function E(t){const e=[];for(let s of t)e.push([s[0][4],s[1][4]]);return e}function C(t,e){const s=Math.min(t.length,e.length,3);let n=0;for(let i=0;i<s;i++)n+=t[i]*e[i];return n}function x(t,e,s){const n=Math.sin(s),i=Math.cos(s);return[t*i-e*n,t*n+e*i]}function R(t,e,s,n){const i=x(e,s,n);return[t,i[0],i[1]]}function b(t,e,s,n){const i=x(t,e,n);return[i[0],i[1],s]}function I(t,e,s,n,i){let h=R(t,e,s,n);return b(h[0],h[1],h[2],i)}function y(t,e,s){const n=Math.min(t.length,e.length,3),i=[];for(let h=0;h<n;h++)i.push(t[h]+s*e[h]);return i}function A(t,e){const s=Math.min(t.length,3),n=[];for(let i=0;i<s;i++)n.push(e*t[i]);return n}function v(t,e){const s=Math.min(t.length,e.length,3),n=[];for(let i=0;i<s;i++)n.push(e[i]-t[i]);return n}function O(t,e,s){const n=Math.min(t.length,e.length,3),i=[];for(let h=0;h<n;h++)i.push(t[h]+s*(e[h]-t[h]));return i}function w(t){const e=Math.min(3,t.length);let s=0;for(let n=0;n<e;n++)s+=t[n]*t[n];if(s>1e-5){const n=1/Math.sqrt(s),i=[];for(let s=0;s<e;s++)i.push(t[s]*n);return i}return[0,0,0]}class P{constructor(t,e){this.O=t,this.D=e,this.X0=e.length<1||0==e[0],this.Y0=e.length<2||0==e[1],this.Z0=e.length<3||0==e[2],this.iX=this.X0?0:1/e[0],this.iY=this.Y0?0:1/e[1],this.iZ=this.Z0?0:1/e[2]}Eval(t){return y(this.O,this.D,t)}Same(t){return t&&t.O==this.O&&t.D==this.D}}t.exports={SetSimplex:function(t){i=t},noise:function(t,e,s,n){return Math.round(DEC*i(Math.round(DEC*n*t)/DEC,Math.round(DEC*n*e)/DEC,Math.round(DEC*n*s)/DEC))/DEC},AngleDifference:function(t,e){const s=(t+Math.PI)%(2*Math.PI),n=(e+Math.PI)%(2*Math.PI);let i=Math.PI;return Math.abs(s-n)<Math.abs(i)&&(i=s-n),Math.abs((s+Math.PI/2)%(2*Math.PI)-n)<Math.abs(i)&&(i=(s+Math.PI/2)%(2*Math.PI)-n),Math.abs((s+Math.PI)%(2*Math.PI)-n)<Math.abs(i)&&(i=(s+Math.PI)%(2*Math.PI)-n),Math.abs((s+3*Math.PI/2)%(2*Math.PI)-n)<Math.abs(i)&&(i=(s+3*Math.PI/2)%(2*Math.PI)-n),i},Distance:r,RayPlane:function(t,e,s){const n=C(s.D,e);if(Math.abs(n)<=1e-4)return[0,0,0,!1,-10];const i=C(v(s.O,t),e)/n;return[s.O[0]+i*s.D[0],s.O[1]+i*s.D[1],s.O[2]+i*s.D[2],!0,i]},RayXY:u,RayXZ:d,RayYZ:f,RaySphere:function(t,e,s){const n=v(s.O,t),i=C(n,s.D),h=y(n,s.D,-i),o=e-C(h,h);if(o<0)return[[0,0,0,!1,-10],[0,0,0,!1,-10]];const r=Math.sqrt(o),a=i-r,l=i+r;return[[s.O[0]+a*s.D[0],s.O[1]+a*s.D[1],s.O[2]+a*s.D[2],!0,a],[s.O[0]+l*s.D[0],s.O[1]+l*s.D[1],s.O[2]+l*s.D[2],!0,l]]},RayCylinder:function(t,e,s,n){const i=v(e,t.O),h=C(s,t.D),o=C(s,i),r=1-h*h,a=C(i,i)-o*o-n;if(Math.abs(r)<1e-4){if(a>0)return[[0,0,0,!1,-10],[0,0,0,!1,-10]];{const e=t.Eval(-999),s=t.Eval(999);return[[e[0],e[1],e[2],!0,-999],[s[0],s[1],s[2],!0,999]]}}const l=C(i,t.D)-o*h;let c=l*l-r*a;if(c<1e-4)return[[0,0,0,!1,-10],[0,0,0,!1,-10]];c=Math.sqrt(c);const u=1/r,d=(-l-c)*u,f=(-l+c)*u;let M=d,m=f;return f<d&&(M=f,m=d),[[t.O[0]+M*t.D[0],t.O[1]+M*t.D[1],t.O[2]+M*t.D[2],!0,M],[t.O[0]+m*t.D[0],t.O[1]+m*t.D[1],t.O[2]+m*t.D[2],!0,m]]},normalize:w,CrossProduct:function(t,e){return t.length<3||e.length<3?[0,0,0]:[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},Rotate:x,fromTo:v,RotateZ:b,RotateZX:function(t,e,s,n,i){let h=b(t,e,s,i);return R(h[0],h[1],h[2],n)},RotateXZ:I,addVec:y,multVec:A,getColorIndices:function(t,e,s,n,i){let h=4*s*(n-1-e-i)+4*t;return[h,h+1,h+2,h+3]},Trace:function(t,e,s){let n=0;n=t.D[0]>=0?Math.min(TX-S,Math.max(Math.floor((t.O[0]+.001)/S)*S,0)):Math.min(TX-S,Math.max(0,Math.floor((t.O[0]+.001-e)/S)*S));let i=0;i=t.D[0]<=0?Math.max(0,Math.min(Math.ceil((t.O[0]-.001)/S)*S,TX-S)):Math.max(0,Math.min(TX-S,Math.ceil((t.O[0]-.001+e)/S)*S));let h=0;h=t.D[1]>=0?Math.min(TY-S,Math.max(Math.floor((t.O[1]+.001)/S)*S,0)):Math.min(TY-S,Math.max(0,Math.floor((t.O[1]+.001-e)/S)*S));let o=0;o=t.D[1]<=0?Math.max(0,Math.min(Math.ceil((t.O[1]-.001)/S)*S,TY-S)):Math.max(0,Math.min(TY-S,Math.ceil((t.O[1]-.001+e)/S)*S));let r=0;r=t.D[2]>=0?Math.min(U,Math.max(Math.floor((t.O[2]+.001)/SZ)*SZ,-Z)):Math.min(U,Math.max(-Z,Math.floor((t.O[2]+.001-e)/SZ)*SZ));let a=0;a=t.D[2]<=0?Math.max(-Z,Math.min(Math.ceil((t.O[2]-.001)/SZ)*SZ,U)):Math.max(-Z,Math.min(U,Math.ceil((t.O[2]-.001+e)/SZ)*SZ));const M=[];if(s&&M.push([t.O[0],t.O[1],t.O[2],!0,0,[0,0,0,t.O[0],t.O[1]]]),o-h>.001)for(let e=h;e<o+1;e+=o-h){const s=d(e,t);s[3]&&(s[4]<=0||c(s,n,i,h,o,r,a)&&M.push(s))}if(i-n>.001)for(let e=n;e<i+1;e+=i-n){const s=f(e,t);s[3]&&(s[4]<=0||c(s,n,i,h,o,r,a)&&M.push(s))}if(a-r>.001)for(let e=r;e<a+1;e+=a-r){const s=u(e,t);s[3]&&(s[4]<=0||c(s,n,i,h,o,r,a)&&M.push(s))}if(M.length<2)return null;let m=9999,p=-9999,g=9999,D=-9999,T=9999,E=-9999;for(let t=0;t<M.length;t++){const e=M[t][0],s=M[t][1],n=M[t][2];m>e&&(m=e),g>s&&(g=s),T>n&&(T=n),p<e&&(p=e),D<s&&(D=s),E<n&&(E=n)}m=Math.max(n,Math.floor((m+.01)/S)*S),g=Math.max(h,Math.floor((g+.01)/S)*S),T=Math.max(r,Math.floor((T+.01)/SZ)*SZ),p=Math.min(i,Math.ceil((p-.01)/S)*S),D=Math.min(o,Math.ceil((D-.01)/S)*S),E=Math.min(a,Math.ceil((E-.01)/SZ)*SZ);for(let e=g;e<D+1;e+=S){if(e==h||e==o)continue;const s=d(e,t);s[3]&&(s[4]<=0||c(s,m,p,g,D,T,E)&&M.push(s))}for(let e=m;e<p+1;e+=S){if(e==n||e==i)continue;const s=f(e,t);s[3]&&(s[4]<=0||c(s,m,p,g,D,T,E)&&M.push(s))}for(let e=T;e<E+1;e+=SZ){if(e==r||e==a)continue;const s=u(e,t);s[3]&&(s[4]<=0||c(s,m,p,g,D,T,E)&&M.push(s))}if(M.length<2)return null;M.sort((function(t,e){return t[4]-e[4]}));for(let s=0;s<M.length-1&&!(M[s][4]>e);s++){const n=l(O(M[s],M[s+1],.5));if(null!=n){const i=n.Intersect(M[s],M[s+1],t,e);if(null!=i)return i}}return null},myRandom:class{constructor(t){this.rng=new n.impl(t)}rnd(){return this.rng.double()}},Camera:class{constructor(t,e,s,n,i){this.planeO=[t,e,s],this.planeX=I(1,0,0,n,i),this.planeY=I(0,1,0,n,i),this.planeZ=I(0,0,1,n,i)}MoveBack(t){this.planeO=y(this.planeO,this.planeZ,t)}GetVector(){return A(this.planeZ,-1)}IsOnScreen(t,e){const s=v(this.planeO,t);return!(Math.abs(C(s,this.planeX))>e+IMG/2)&&!(Math.abs(C(s,this.planeY))>e+RATIO_H*IMG/(2*RATIO_W))}ScCenDist(t){const e=v(this.planeO,t);return Math.sqrt(Math.pow(C(e,this.planeX),2)+Math.pow(C(e,this.planeY),2))}},Ray:P,Span:class extends P{constructor(t,e){super(t,w(v(t,e))),this.length=r(t,e),this.E=e,this.weight=0}Same(t){return t&&o(t.O,this.O)<1e-4&&o(t.E,this.E)<1e-4}ClosestPoint(t){const e=Math.max(0,Math.min(this.length,C(v(this.O,t),this.D))),s=this.Eval(e);return[s,o(t,s)]}addToBoxes(){if(this.O.length<3||this.E.length<3)return;const t=a([[[Math.min(this.O[0],this.E[0]),Math.max(this.O[0],this.E[0])]],[[Math.min(this.O[1],this.E[1]),Math.max(this.O[1],this.E[1])]],[[Math.min(this.O[2],this.E[2]),Math.max(this.O[2],this.E[2])]]]);for(let e of t){if(!e.visible)continue;let t=!1;for(let s of e.spans)if(this.Same(s)){t=!0;break}t||e.spans.push(this)}}},Contains:h,DotProduct:C,GetBoxes:a,IntervalSum:T,HitIntervalSum:function(t){return T(E(t),t)},HitIntervalIntersect:function(t,e){return D(E(t),E(e),t,e)},HitIntervalDifference:function(t,e){return function(t,e,s,n){if(0==t.length)return[];if(0==e.length)return T(t,s);const i=[],h=[];for(let e=0;e<t.length;e++)i.push(t[e]),h.push(null!=s&&s.length==t.length?s[e]:t[e]);for(let t=0;t<e.length;t++)i.push(e[t]),h.push(null!=n&&n.length==e.length?n[t]:e[t]);const o=p(i),r=[];for(let s=0;s<o.length-1;s++){const n=.5*(o[s][0]+o[s+1][0]);r.push(m(n,t)&&!m(n,e))}return g(o,r,h)}(E(t),E(e),t,e)},SetD:function(t){s.g.D=Math.max(.01,DDOM[2]+DDOM[3]*Math.min(1,Math.max(0,(t-DDOM[0])/Math.max(.01,DDOM[1]))))},BoxIntersect:function(t,e){return t.length<3||e.length<3?[[],[],[]]:[D(t[0],e[0]),D(t[1],e[1]),D(t[2],e[2])]},BoxSum:function(t){const e=[],s=[],n=[];for(let i of t)if(!(i.length<3)){for(let t of i[0])e.push(t);for(let t of i[1])s.push(t);for(let t of i[2])n.push(t)}return[T(e),T(s),T(n)]},IntervalsOverlap:function(t,e){return M(t[0],e)||M(t[1],e)||M(e[0],t)||M(e[1],t)},IntervalInInterval:function(t,e){return M(t[0],e)&&M(t[1],e)},CalculateDepth:function(t,e){return.12*(1-(t+Z+12)/(Z+U+25))+1.8*(e-TX/4)/TX},MultiArray:function(t){const e=[];for(let s=0;s<t;s++)e.push([]);return e}}}},e={};function s(n){var i=e[n];if(void 0!==i)return i.exports;var h=e[n]={exports:{}};return t[n](h,h.exports,s),h.exports}s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var n in e)s.o(e,n)&&!s.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t=s(824),e=s(80),n=s(374),i=s(413),h=s(479),o=s(555),r=s(6),a=s(470),l=s(290),c=document.createElement("a");c.style.display="none",document.body.appendChild(c);console.log("Seed: "+tokenData.hash),s.g.RATIO_W=2,s.g.RATIO_H=3,s.g.DEC=1e4,s.g.RENMOD=12,s.g.RENMOD2=RENMOD*RENMOD,s.g.TERTYPE=0,s.g.CUTTYPE=1,s.g.SOLTYPE=3,s.g.BLDTYPE=4,s.g.VAULT=0,s.g.DOMES=1,s.g.CUTS=2,s.g.ORTHO=0,s.g.SIXTY=1,s.g.FRAGMENTED=0,s.g.HOLISTIC=1,s.g.REPLACE=0,s.g.ADD=1,s.g.MAX=2,s.g.MIN=3,s.g.MINTH=.9,s.g.MINTH_TRIM=1.2,s.g.T_SC=2,s.g.R=new t.Random;const u=R.random_dec(),d=[[.2,2,3,2448],[.15,3,2,2448],[.15,3,4,2308],[.1,4,3,2308],[.1,1,1,2e3],[.15,9,16,2672],[.15,16,9,2672]];let f=0,M=2e3;for(let t=0;t<d.length;t++)if(f+=d[t][0],u<=f||t==d.length-1){s.g.RATIO_W=d[t][1],s.g.RATIO_H=d[t][2],M=d[t][3];break}s.g.S=16,s.g.MODULE=2*S,s.g.U=4.5*MODULE,s.g.Z=0,s.g.SZ=S,s.g.DIAG=Math.sqrt(2*S*S+SZ*SZ),s.g.TX=16*MODULE,s.g.TY=16*MODULE,s.g.DDOM=[0,1,2,2],s.g.D=1;const m=R.random_dec(),p=R.random_dec()<.33,g=Math.floor(1.45*R.random_dec()),D=Math.floor(24.99*R.random_dec())*Math.PI/12,T=Math.PI/2+Math.floor(5.9*R.random_dec())*Math.PI/12*(R.random_dec()<.5?1:-1);s.g.BOOLTYPE=VAULT;const E=Math.round(.75*R.random_dec());s.g.OMITSECOND=R.random_dec()<.25,m<.25?s.g.BOOLTYPE=DOMES:m<.5&&(s.g.BOOLTYPE=CUTS),BOOLTYPE==DOMES&&(s.g.MINTH=.4,s.g.MINTH_TRIM=.7),s.g.TERCLR=[.38,.37,.36],s.g.CUTCLR=[.9,.9,.9],s.g.STNCLR=[.7,.7,.7],s.g.SOLCLR=[.8,.8,.8],s.g.BLDCLR=[.75,.75,.75],s.g.SHDCLR=[.44,.51,.59],s.g.LGHCLR=[1.04,1,.82],s.g.BLKCLR=[0,0,0];let C=Math.floor(12.99*R.random_dec())*Math.PI/12-Math.PI/2;Math.abs(C)>.1&&(C>0?C-=.06:C+=.06);const x=[];C<0?x.push(-Math.PI/6):x.push(Math.PI/6),x.push(Math.PI/2),x.push(0);const b=x[Math.max(0,Math.min(x.length-1,Math.floor(Math.pow(R.random_dec(),2)*(x.length-.01))))];C-=D,s.g.LV=(0,o.RotateXZ)(0,1,0,.33,C),s.g.STRIPEV=(0,o.RotateZ)(0,1,0,-D-b);const I=Math.floor(DEC*(RATIO_W/RATIO_H)*500/2)/DEC;s.g.IMG=I;let y=0,A=RENMOD2,v=self.innerWidth,O=self.innerHeight;try{const t=new URLSearchParams(window.location.search),e=t.get("h"),s=t.get("w"),n=t.get("machine");if(e&&(O=parseInt(e),console.log("set H to "+O)),s&&(v=parseInt(s),console.log("set W to "+v)),n&&"true"==n){const t=Math.sqrt(Math.max(1,O*v/(RATIO_H*RATIO_W)));O=Math.round(Math.max(RATIO_H,RATIO_W)*t),v=Math.round(Math.max(RATIO_H,RATIO_W)*t)}}catch{v=self.innerWidth,O=self.innerHeight}const w=document.createElement("canvas");w.id="sumCanvas";const P=w.getContext("2d");document.body.prepend(w);const N=document.createElement("canvas");N.id="mainCanvas",N.style.display="none",s.g.mainCtx=N.getContext("2d",{willReadFrequently:!0}),document.body.prepend(N);const B=document.createElement("canvas");B.id="saveCanvas",B.style.display="none";const L=B.getContext("2d");document.body.prepend(B),function(t,e,s,n){let i=Math.max(2*RENMOD*s,Math.min(RENMOD*s*Math.ceil(t/(RENMOD*s)),RENMOD*s*Math.ceil(e/(RENMOD*n)))),h=Math.round(n*i/s);console.log("best size for w="+t+", h="+e+" is "+i+"x"+h),N.width=Math.round(i),N.height=Math.round(h),w.width=N.width,w.height=N.height,B.width=N.width,B.height=N.height,y=0,A=RENMOD2*Math.min(20,Math.round(Math.max(1,4e3/Math.max(1,N.height+N.width))))}(v,O,RATIO_W,RATIO_H),s.g.W=N.width,s.g.H=N.height,s.g.SC=IMG/W,s.g.STRIPEMULT=.95,s.g.MINDEPTH=0,s.g.DEPTH_1_=.125,s.g.DEPTH_1=.25,s.g.DEPTH_2=.75,s.g.DEPTH_2_=.125,s.g.MAXDEPTH=1,s.g.CENTERPT=[(TX-S)/2,(TX-S)/2,0],s.g.LAND=null,s.g.BLOCKS=[],s.g.CAM=new o.Camera((TX-S)/2,(TY-S)/2,U/2,Math.PI/4,-D),CAM.MoveBack(590);try{window.$artifact={features:{"Aspect ratio":RATIO_W+":"+RATIO_H}},window.$artifact.aspectRatio=RATIO_W/RATIO_H,console.log(window.$artifact.features)}catch{}let _=!1;for(;!_;)try{(0,o.SetSimplex)((0,i.makeNoise3D)(Math.round(DEC*R.random_dec())));const t=Math.round(1e5*R.random_dec())/1e3,h=Math.round(1e5*R.random_dec())/1e3;console.log("generate landscape"),s.g.LAND=new n.Mountain(.003,h,.003,t),s.g.BLOCKS=[];for(let t=0;t<TX-S-1;t+=S){const s=[];for(let n=0;n<TY-S-1;n+=S){const i=[];for(let s=-Z;s<U-1;s+=SZ)i.push(new e.BBlock(t,n,s,S,SZ));s.push(i)}BLOCKS.push(s)}let c=999;for(let t=-50;t<50.1;t++)for(let e=-50;e<50.1;e++){const n=t+(TX-S)/2,i=e+(TY-S)/2,h=LAND.Evaluate(n,i),o=CAM.ScCenDist([n,i,h]);c>o&&(c=o,s.g.CENTERPT=[n,i,0])}s.g.IMG=I;for(let t=0;t<1.1;t++)for(let e=0;e<1.1;e++)for(let n=0;n<1.1;n++)for(let i=-1;i<1.1;i+=2){const h=(0,o.RayPlane)([t*(TX-S),t*(TY-S),e*U],(0,o.normalize)((0,o.CrossProduct)(CAM.planeZ,n<.5?[1,0,0]:[0,1,0])),new o.Ray(CAM.planeO,(0,o.normalize)((0,o.addVec)((0,o.addVec)([0,0,0],CAM.planeX,RATIO_W),CAM.planeY,RATIO_H*i))));h&&h[3]&&(s.g.IMG=Math.min(2*Math.abs((0,o.DotProduct)((0,o.fromTo)(CAM.planeO,h),CAM.planeX)),IMG))}s.g.IMG=Math.max(10,Math.floor(DEC*IMG)/DEC),s.g.SC=IMG/W,s.g.STRIPEMULT=Math.max(.01,.95*IMG*Math.min(1.1,Math.max(.85,1.1-.75*(W+H-500-750)/8e3))/I);try{if(BOOLTYPE==VAULT){let t=Math.PI/2;if(t=g==SIXTY?Math.PI/3:Math.min(T,Math.PI-T),t>.1&&t<Math.PI/2+.1){let e=.25*(S*Math.tan(Math.PI/2-t)+S/Math.max(.001,Math.tan((Math.PI-t)/2)));s.g.STRIPEMULT=e/Math.max(1,Math.round(e/STRIPEMULT))}}}catch(t){}for(let t of BLOCKS)for(let e of t)for(let t of e)t.Resolve();console.log("boolean operations"),BOOLTYPE==DOMES?(0,l.Domes)():BOOLTYPE==CUTS?(0,l.Signs)():new r.Grid3d(g,T,p,E),console.log("calculate habitat"),LAND.CalculateVisibility(),LAND.CalculateThickness(),LAND.CalculateHabitat();for(let t of BLOCKS)for(let e of t)for(let t of e)t.ResolveSpans();(0,a.GenerateBuildings)(),(0,a.GenerateFields)(),(0,a.GenerateTrees)(),LAND.detailedMap.Smooth(2,.4,!0),LAND.detailedMap.Erode(7e4,.05,20,.075,.075,!1,1,1,1,1),s.g.MINDEPTH=9999,s.g.MAXDEPTH=-9999;const u=[],d=CAM.GetVector();for(let t=-IMG/2;t<IMG/2;t+=5)for(let e=-RATIO_H*IMG/(2*RATIO_W);e<RATIO_H*IMG/(2*RATIO_W);e+=5){let n=(0,o.addVec)(CAM.planeO,CAM.planeX,t);n=(0,o.addVec)(n,CAM.planeY,e),s.g.DDOM=[500,600,1,2];let i=(0,o.Trace)(new o.Ray(n,d),5e3,!1);if(!i)continue;const h=(0,o.CalculateDepth)(i[2],i[4]);u.push(h),s.g.MINDEPTH=Math.min(MINDEPTH,h),s.g.MAXDEPTH=Math.max(MAXDEPTH,h)}u.sort((function(t,e){return t-e})),u.length>1?(s.g.MINDEPTH=u[0],s.g.MAXDEPTH=u[u.length-1],s.g.MAXDEPTH=Math.max(MAXDEPTH,MINDEPTH+.1),s.g.DEPTH_1=(u[Math.max(0,Math.min(u.length-1,Math.round(.32*u.length)))]-MINDEPTH)/(MAXDEPTH-MINDEPTH),s.g.DEPTH_2=(u[Math.max(0,Math.min(u.length-1,Math.round(.68*u.length)))]-MINDEPTH)/(MAXDEPTH-MINDEPTH),s.g.DEPTH_1_=DEPTH_1-(u[Math.max(0,Math.min(u.length-1,Math.round(.2*u.length)))]-MINDEPTH)/(MAXDEPTH-MINDEPTH),s.g.DEPTH_2_=(u[Math.max(0,Math.min(u.length-1,Math.round(.8*u.length)))]-MINDEPTH)/(MAXDEPTH-MINDEPTH)-DEPTH_2):(s.g.MINDEPTH=0,s.g.DEPTH_1_=.125,s.g.DEPTH_1=.25,s.g.DEPTH_2=.75,s.g.DEPTH_2_=.125,s.g.MAXDEPTH=1),_=!0;break}catch(t){_=!1,console.log("problem. repeating.")}console.log("render"),setInterval((function(){!function(){if(y<A)try{0==y&&(L.fillStyle="#212124",L.fillRect(-10,-10,W+20,H+20)),(0,h.renderLight)(y,5e3),L.drawImage(N,0,0)}catch(t){console.log(t),mainCtx.drawImage(B,0,0),y--}y<=A+1&&P.drawImage(N,0,0);try{if(y<A){const t=(W+H)/2;!function(t,e){P.fillStyle="#212124dd",P.beginPath(),P.moveTo((W-t)/2,(H-t)/2-e),P.lineTo((W+t)/2+e,(H-t)/2-e),P.lineTo((W+t)/2+e,(H+t)/2+1.7*e),P.lineTo((W-t)/2-e,(H+t)/2+1.7*e),P.lineTo((W-t)/2-e,(H-t)/2),P.closePath(),P.fill(),P.strokeStyle="#ffffff",P.fillStyle="#ffffff",P.lineWidth=.07*e;const s=40,n=RENMOD2,i=(y+1)/Math.max(1,A);P.font=.57*e+"px Arial Narrow, sans-serif",P.textBaseline="middle",P.textAlign="right",P.fillText(Math.round(100*i)+"%",(W+t)/2,(H+t+1.95*e)/2),P.textAlign="left",P.fillText(y<RENMOD2?"RENDER":"ENHANCE",(W-t)/2,(H+t+1.7*e)/2);const h=2,o=Math.max(1,n-(s-1)*h);for(let r=0;r<s;r++){const a=(r+.5)/s,l=(TX-S)*a,c=r*h;P.beginPath();for(let s=0;s<Math.ceil(Math.min(o+.1,(n+.1)*i-c));s++){let n=s/o;r%2==0&&(n=(o-s)/o);const i=(TY-S)*n,h=LAND.t0.EvalFromWorld(l,i,!1),c=-.5+h[2],u=(W-t)/2+n*t,d=(H+t)/2-a*t-c*e*2-e/2;0==s||h[1]>1e-4||d<(H-t)/2||d>(H+t)/2?P.moveTo(u,d):P.lineTo(u,d)}P.stroke()}}(t/6,t/64)}}catch(t){console.log(t)}if(y==A+2)try{dispatchEvent(new Event("capture-preview")),console.info("###verse-preview-capture")}catch(t){console.log(t)}y++,y>2e5&&(y=2e5)}()}),80)})()})();